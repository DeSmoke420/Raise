
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Forecast Intelligence Platform</title>
  <link rel="icon" type="image/png" href="static/logo2.png?v=2" sizes="512x512">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary-color: #10b981;
      --accent-color: #f59e0b;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: var(--font-family);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      padding: 3rem;
      width: 100%;
      max-width: 700px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .header {
      text-align: center;
      margin-bottom: 2.5rem;
      position: relative;
      z-index: 1;
    }

    .logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .logo i {
      font-size: 1.75rem;
      color: white;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 400;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      width: 100%;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--bg-color);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }

    .btn-back {
      background: transparent;
      color: var(--text-secondary);
      border: 2px solid var(--border-color);
      font-weight: 500;
    }

    .btn-back:hover {
      background: var(--bg-color);
      color: var(--text-primary);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Custom spinning animation for download buttons */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .spinning {
      animation: spin 1s linear infinite;
    }

    .download-loading {
      position: relative;
    }

    .download-loading i {
      animation: spin 1s linear infinite;
    }

    /* Enhanced loading state for download buttons */
    .btn:disabled .spinning {
      animation: spin 1s linear infinite, pulse 2s ease-in-out infinite;
    }

    .field {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .input-group {
      position: relative;
    }

    .input-group i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      z-index: 1;
    }

    input[type="file"], select, input[type="number"] {
      width: 100%;
      padding: 0.875rem 1rem;
      padding-left: 2.5rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      background: var(--card-bg);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    input[type="file"] {
      padding-left: 1rem;
    }

    input[type="file"]::-webkit-file-upload-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      margin-right: 1rem;
      font-weight: 500;
    }

    input[type="file"]::-webkit-file-upload-button:hover {
      background: var(--primary-dark);
    }

    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
    }
    
    /* Ensure select dropdown text doesn't overlap with icons */
    select {
      text-indent: 0;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
      padding-right: 2.5rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    


    .hidden {
      display: none !important;
    }

    /* Info Boxes */
    .info-box {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .info-box h3 {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-box p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .info-box.warning {
      background: rgb(245 158 11 / 0.1);
      border-color: var(--warning-color);
    }

    .info-box.warning h3 {
      color: var(--warning-color);
    }

    .info-box.success {
      background: rgb(16 185 129 / 0.1);
      border-color: var(--secondary-color);
    }

    .info-box.success h3 {
      color: var(--secondary-color);
    }

    /* Progress Bar */
    .progress-container {
      margin: 1rem 0;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border-color);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 2rem;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--shadow-xl);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .modal-text {
      font-size: 1.1rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .modal-details {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-color);
      border-radius: var(--radius-md);
      text-align: left;
      font-size: 0.9rem;
      color: var(--text-secondary);
      max-height: 200px;
      overflow-y: auto;
    }

    .modal-buttons {
      margin-top: 1.5rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .card {
        padding: 2rem;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      h1 {
        font-size: 1.75rem;
      }
      
      /* Mobile-specific header adjustments */
      .header {
        margin-bottom: 2rem;
      }
      
      .logo {
        width: 56px;
        height: 56px;
        margin-bottom: 1rem;
      }
      
      .logo i {
        font-size: 1.5rem;
      }
      
      /* Ensure proper spacing between header and form fields */
      .header + .info-box,
      .header + .field {
        margin-top: 1rem;
      }
      
      /* Adjust input group positioning for mobile */
      .input-group {
        margin-bottom: 0.5rem;
      }
      
      /* Ensure select dropdowns don't get cut off */
      select {
        max-height: 200px;
      }
      
      /* Additional mobile spacing fixes */
      .field {
        margin-bottom: 1.25rem;
      }
      
      /* Ensure form elements have proper spacing from header */
      #forecastPage .header {
        margin-bottom: 1.5rem;
      }
      
      /* Prevent any potential overlap with absolute positioned elements */
      .input-group i {
        z-index: 2;
      }
      
      /* Fix input field icon spacing on mobile */
      input[type="file"], select, input[type="number"] {
        padding-left: 3rem;
      }
      
      .input-group i {
        left: 1.25rem;
        font-size: 0.9rem;
      }
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }

    /* File upload styling */
    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-lg);
      background: var(--bg-color);
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-upload-label:hover {
      border-color: var(--primary-color);
      background: rgb(99 102 241 / 0.05);
    }

    .file-upload-label i {
      font-size: 1.25rem;
    }

    /* Success/Error states */
    .success {
      border-color: var(--secondary-color) !important;
      background: rgb(16 185 129 / 0.05) !important;
    }

    .error {
      border-color: var(--error-color) !important;
      background: rgb(239 68 68 / 0.05) !important;
    }

    /* Data Preview */
    .data-preview {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-color);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      display: none;
    }

    .data-preview h4 {
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .data-preview table {
      width: 100%;
      font-size: 0.8rem;
      border-collapse: collapse;
    }

    .data-preview th,
    .data-preview td {
      padding: 0.25rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .data-preview th {
      font-weight: 600;
      color: var(--text-primary);
    }

    .data-preview td {
      color: var(--text-secondary);
    }
    
    /* Forecast Preview Chart */
    .forecast-preview {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--bg-color);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      display: none;
    }
    
    .forecast-preview h3 {
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    .chart-summary {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }
    
    .chart-summary h4 {
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .chart-summary p {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin: 0.25rem 0;
    }
    
    .download-options {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--bg-color);
      border-radius: var(--radius-lg);
      border: 2px solid var(--border-color);
    }
    
    .download-options h4 {
      margin-bottom: 1rem;
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .download-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .download-buttons .btn {
      flex: 1;
      min-width: 160px;
      max-width: 220px;
      font-size: 0.9rem;
      padding: 0.75rem 1rem;
    }
    
    /* Download buttons: both grey by default, purple on hover */
    .download-buttons .btn {
      background: var(--bg-color);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      box-shadow: var(--shadow-md);
      transition: background 0.2s, color 0.2s, transform 0.15s, box-shadow 0.2s, border-color 0.2s;
    }
    .download-buttons .btn:hover {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-dark);
    }
    
    @media (max-width: 768px) {
      .download-buttons {
        flex-direction: column;
      }
      .download-buttons .btn {
        min-width: auto;
        max-width: none;
        font-size: 0.85rem;
        padding: 0.7rem 0.9rem;
      }
    }
    .site-logo {
      position: absolute;
      top: 24px;
      left: 24px;
      z-index: 100;
      display: flex;
      align-items: center;
      text-decoration: none;
    }
    .site-logo img {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(99,102,241,0.10);
      background: #fff;
      padding: 8px;
      transition: box-shadow 0.2s;
    }
    .site-logo:hover img {
      box-shadow: 0 4px 16px rgba(99,102,241,0.18);
    }
    @media (max-width: 768px) {
      .site-logo {
        top: 10px;
        left: 10px;
      }
      .site-logo img {
        width: 60px;
        height: 60px;
        padding: 5px;
      }
    }
  </style>
</head>
<body>
  <a href="/" class="site-logo">
    <img src="static/logo.png" alt="r4ise logo" />
  </a>
  <div class="container">
    <!-- Home Page -->
    <div class="card fade-in" id="homePage">
      <div class="header">
        <div class="logo">
          <i class="fas fa-chart-line"></i>
        </div>
        <h1>AI Forecast Intelligence</h1>
        <p class="subtitle">Advanced forecasting powered by machine learning</p>
      </div>
      
      <button class="btn btn-primary" onclick="showPage('forecastPage')">
        <i class="fas fa-magic"></i>
        Generate Forecast
      </button>
    </div>

    <!-- Forecast Page -->
    <div class="card hidden slide-in" id="forecastPage">
      <div class="header">
        <h1>Generate Forecast</h1>
        <p class="subtitle">Upload your historical data to generate AI-powered forecasts</p>
      </div>
      
      <div class="info-box">
        <h3><i class="fas fa-info-circle"></i>Data Requirements</h3>
        <p>Your Excel file (.xlsx) must contain exactly three columns with the following headers: <strong>"Date"</strong>, <strong>"Item"</strong>, and <strong>"Quantity"</strong>. The <strong>"Date"</strong> column must be in a valid Excel date format such as <em>dd/mm/yyyy, mm/dd/yyyy, or mm/yyyy</em>. The <strong>"Item"</strong> column can be either text or a number. The <strong>"Quantity"</strong> column must contain numeric values only, with or without decimals, and should not include any thousands separators (e.g., write "1000" instead of "1,000"). Both European (e.g., "1000,5") and US (e.g., "1000.5") decimal formats are accepted. The system will automatically detect the order of the columns based on their headers.</p>
      </div>
      
      <div class="field">
        <label for="historicalFile">
          <i class="fas fa-upload"></i> Historical Data
        </label>
        <div class="file-upload">
          <input type="file" id="historicalFile" accept=".xlsx,.xls,.csv" onchange="previewData(this)">
          <div class="file-upload-label">
            <i class="fas fa-file-upload"></i>
            <span>Choose file or drag and drop</span>
          </div>
        </div>
        <div class="data-preview" id="dataPreview">
          <h4>Data Preview</h4>
          <div id="previewTable"></div>
        </div>
      </div>
      
      <div class="grid">
        <div class="field">
          <label for="timeUnit">
            <i class="fas fa-clock"></i> Time Unit
          </label>
          <div class="input-group">
            <i class="fas fa-calendar"></i>
            <select id="timeUnit">
              <option value="monthly">Monthly</option>
              <option value="weekly">Weekly</option>
              <option value="daily">Daily</option>
            </select>
          </div>
        </div>
        
        <div class="field">
          <label for="periodCount">
            <i class="fas fa-hashtag"></i> Forecast Periods
          </label>
          <div class="input-group">
            <i class="fas fa-chart-bar"></i>
            <input type="number" id="periodCount" min="1" max="120" placeholder="e.g. 12" value="12">
          </div>
        </div>
        
        <div class="field">
          <label for="dateFormat">
            <i class="fas fa-globe"></i> Date Format
          </label>
          <div class="input-group">
            <i class="fas fa-calendar-alt"></i>
            <select id="dateFormat">
              <option value="EUR">EUR (DD/MM/YYYY)</option>
              <option value="US">US (MM/DD/YYYY)</option>
            </select>
          </div>
        </div>
        
        <div class="field">
          <label for="decimalPlaces">
            <i class="fas fa-calculator"></i> Decimal(s)
          </label>
          <div class="input-group">
            <i class="fas fa-hashtag"></i>
            <select id="decimalPlaces">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
        </div>
        
        <div class="field">
          <label for="allowNegative">
            <i class="fas fa-shield-alt"></i> Allow Negative Forecast Values
          </label>
          <div class="input-group">
            <i class="fas fa-minus-circle"></i>
            <select id="allowNegative">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
        </div>
      </div>
      

      

      
      <button class="btn btn-primary" onclick="generateForecast()" id="generateBtn">
        <i class="fas fa-rocket"></i>
        Generate Forecast
      </button>
      
      <button class="btn btn-back" onclick="showPage('homePage')">
        <i class="fas fa-arrow-left"></i>
        Back to Home
      </button>
      
      <!-- Forecast Preview Chart -->
      <div class="forecast-preview" id="forecastPreview">
        <h3><i class="fas fa-chart-line"></i> Forecast Preview</h3>
        <div class="chart-container">
          <canvas id="forecastChart"></canvas>
        </div>
        <div class="chart-summary" id="chartSummary">
          <h4>Summary</h4>
          <p id="summaryText"></p>
        </div>
        <div class="download-options" id="downloadOptions" style="display: none;">
          <h4><i class="fas fa-download"></i> Download Forecast</h4>
          <div class="download-buttons">
            <button class="btn btn-primary" onclick="downloadForecast('xlsx')">
              <i class="fas fa-file-excel"></i>
              Download Excel (.xlsx)
            </button>
            <button class="btn btn-secondary" onclick="downloadForecast('csv')">
              <i class="fas fa-file-csv"></i>
              Download CSV (.csv)
            </button>
          </div>
        </div>
      </div>
    </div>


  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="spinner" id="modalSpinner"></div>
      <p class="modal-text" id="modalText">Processing your request<span id="dots">.</span></p>
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Processing...</div>
      </div>
      <div class="modal-details" id="modalDetails" style="display: none;"></div>
      <div class="modal-buttons" id="modalButtons" style="display: none;">
        <button class="btn btn-back" onclick="hideModal()">
          <i class="fas fa-arrow-left"></i>
          Back
        </button>
      </div>
    </div>
  </div>

  <!-- Add after the main modal, before </body> -->
  <div class="modal" id="authModal">
    <div class="modal-content" style="max-width: 400px;">
      <a href="/" class="site-logo" style="position: static; margin-bottom: 1.5rem; display: flex; justify-content: center;">
        <img src="static/logo.png" alt="r4ise logo" style="width: 60px; height: 60px; border-radius: 16px; box-shadow: 0 2px 8px rgba(99,102,241,0.10); background: #fff; padding: 5px;" />
      </a>
      <h2 id="authTitle" style="margin-bottom: 1rem; color: var(--primary-color);">Sign In</h2>
      <form id="authForm">
        <div class="field">
          <label for="authEmail">Email</label>
          <input type="email" id="authEmail" required style="width: 100%; padding: 0.75rem; border-radius: var(--radius-lg); border: 2px solid var(--border-color);">
        </div>
        <div class="field">
          <label for="authPassword">Password</label>
          <input type="password" id="authPassword" required style="width: 100%; padding: 0.75rem; border-radius: var(--radius-lg); border: 2px solid var(--border-color);">
        </div>
        <div class="field" id="authError" style="color: var(--error-color); font-size: 0.95rem; display: none;"></div>
        <button type="submit" class="btn btn-primary" id="authSubmitBtn">Sign In</button>
        <button type="button" class="btn btn-secondary" id="toggleAuthMode" style="margin-top: 0.5rem;">Don't have an account? Register</button>
      </form>
    </div>
  </div>

  <script>
    const modal = document.getElementById('modal');
    const dots = document.getElementById('dots');
    let dotInterval;

    function showPage(id) {
      document.querySelectorAll('.card').forEach(div => {
        div.classList.add('hidden');
        div.classList.remove('fade-in', 'slide-in');
      });
      const targetPage = document.getElementById(id);
      targetPage.classList.remove('hidden');
      targetPage.classList.add(id === 'homePage' ? 'fade-in' : 'slide-in');
      
      // Reset form states
      if (id === 'forecastPage') {
        resetForecastForm();
      }
    }

    function resetForecastForm() {
      document.getElementById('historicalFile').value = '';
      document.getElementById('periodCount').value = '12';
      document.getElementById('dateFormat').value = 'EUR';
      document.getElementById('decimalPlaces').value = '0';
      document.getElementById('allowNegative').value = 'false';
      document.getElementById('dataPreview').style.display = 'none';
      document.getElementById('forecastPreview').style.display = 'none';
      document.getElementById('downloadOptions').style.display = 'none';
      document.getElementById('generateBtn').disabled = false;
      updateFileLabel('historicalFile', 'Choose file or drag and drop');
      // Clear stored forecast settings
      window.forecastSettings = null;
    }



    function updateFileLabel(inputId, defaultText) {
      const input = document.getElementById(inputId);
      const label = input.parentElement.querySelector('.file-upload-label');
      label.classList.remove('success', 'error');
      label.innerHTML = `<i class="fas fa-file-upload"></i><span>${defaultText}</span>`;
    }

    function showModal(msg, details = null, showButtons = false, showProgress = false) {
      document.getElementById('modalText').textContent = msg;
      const detailsDiv = document.getElementById('modalDetails');
      const buttonsDiv = document.getElementById('modalButtons');
      const spinner = document.getElementById('modalSpinner');
      const progressContainer = document.getElementById('progressContainer');
      
      if (details) {
        detailsDiv.innerHTML = details;
        detailsDiv.style.display = 'block';
      } else {
        detailsDiv.style.display = 'none';
      }
      
      if (showButtons) {
        buttonsDiv.style.display = 'flex';
        spinner.style.display = 'none';
        progressContainer.style.display = 'none';
        clearInterval(dotInterval);
      } else if (showProgress) {
        buttonsDiv.style.display = 'none';
        spinner.style.display = 'none';
        progressContainer.style.display = 'block';
        simulateProgress();
      } else {
        buttonsDiv.style.display = 'none';
        progressContainer.style.display = 'none';
        spinner.style.display = 'block';
      let count = 1;
      dotInterval = setInterval(() => {
        dots.textContent = '.'.repeat(count);
        count = count === 3 ? 1 : count + 1;
      }, 500);
      }
      
      modal.style.display = 'flex';
    }

    function hideModal() {
      modal.style.display = 'none';
      clearInterval(dotInterval);
    }



    function simulateProgress() {
      const fill = document.getElementById('progressFill');
      const text = document.getElementById('progressText');
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        fill.style.width = progress + '%';
        text.textContent = `Processing... ${Math.round(progress)}%`;
        if (progress >= 90) {
          clearInterval(interval);
        }
      }, 500);
    }

    function previewData(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const wb = XLSX.read(e.target.result, { type: 'binary' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          
          if (data.length > 0) {
            const headers = data[0];
            const preview = data.slice(1, 6); // Show first 5 rows
            
            let tableHTML = '<table><thead><tr>';
            headers.forEach(header => {
              tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            preview.forEach(row => {
              tableHTML += '<tr>';
              row.forEach((cell, index) => {
                const header = headers[index] ? headers[index].toLowerCase() : '';
                let displayValue = cell === undefined || cell === null ? '' : cell;

                // Format quantity columns to 2 decimals
                if (header.includes('quantity') || header.includes('qty') || header.includes('amount')) {
                  displayValue = Number(cell).toFixed(2);
                }
                // Only try to convert to date if header is a date/time/period column
                else if (header.includes('date') || header.includes('time') || header.includes('period')) {
                  if (typeof cell === 'number' && cell > 1000) {
                    try {
                      const excelDate = new Date((cell - 25569) * 86400 * 1000);
                      if (!isNaN(excelDate.getTime())) {
                        displayValue = excelDate.toLocaleDateString('en-US', {
                          year: 'numeric',
                          month: 'short'
                        });
                      }
                    } catch (dateError) {
                      // If date conversion fails, keep original value
                      console.log('Date conversion failed for:', cell);
                    }
                  }
                }
                // For item id and all other columns, just display as string

                tableHTML += `<td>${displayValue}</td>`;
              });
              tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            
            document.getElementById('previewTable').innerHTML = tableHTML;
            document.getElementById('dataPreview').style.display = 'block';
          }
        } catch (error) {
          console.error('Error previewing data:', error);
        }
      };
      reader.readAsBinaryString(file);
    }

    function readFileAsCSV(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const csv = XLSX.utils.sheet_to_csv(sheet, { FS: ',', RS: '\n', strip: true });
            resolve(csv);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = e => reject(e);
        reader.readAsBinaryString(file);
      });
    }

    async function generateForecast() {
      const file = document.getElementById('historicalFile').files[0];
      const timeUnit = document.getElementById('timeUnit').value;
      const periods = document.getElementById('periodCount').value.trim();
      const dateFormat = document.getElementById('dateFormat').value;
      const decimalPlaces = document.getElementById('decimalPlaces').value;
      const allowNegative = document.getElementById('allowNegative').value === 'true';

      if (!file) {
        showError('Please upload a historical data file');
        return;
      }

      if (!periods || periods < 1 || periods > 120) {
        showError('Please specify a valid number of periods (1-120)');
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      generateBtn.disabled = true;
      showModal("Analyzing your data and generating forecasts...", null, false, true);

      try {
        const csv = await readFileAsCSV(file);
        console.log('Sending forecast request...');
        
        // Store current settings for later download
        window.forecastSettings = {
          csv,
          timeUnit,
          periods,
          dateFormat,
          decimalPlaces: parseInt(decimalPlaces),
          allowNegative: allowNegative
        };
        
        const res = await fetch('/api/forecast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            csv, 
            timeUnit, 
            periods, 
            exportFormat: 'csv', // Always get CSV for preview
            dateFormat: dateFormat,
            decimalPlaces: parseInt(decimalPlaces),
            allowNegative: allowNegative
          })
        });
        
        console.log('Response status:', res.status);
        console.log('Response headers:', Object.fromEntries(res.headers.entries()));
        
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || "Forecast generation failed");
        }
        
        // Handle response for preview
        const contentType = res.headers.get('content-type');
        console.log('Content-Type:', contentType);
        const blob = await res.blob();
        console.log('Blob size:', blob.size);
        
        // Parse and show preview
        await parseForecastAndCreateChart(blob, 'csv');
        showSuccess('Forecast generated successfully! Preview is now available.');
        
      } catch (e) {
        console.error('Forecast error:', e);
        showError('Error: ' + e.message);
      } finally {
        generateBtn.disabled = false;
        hideModal();
      }
    }



    function showError(message) {
      showModal('Error', `<div style="color: var(--error-color); font-weight: 600;">${message}</div>`, true);
    }

    function showSuccess(message) {
      showModal('Success', `<div style="color: var(--secondary-color); font-weight: 600;">${message}</div>`);
      setTimeout(hideModal, 2000);
    }

    function downloadCSV(text, filename) {
      const blob = new Blob([text], { type: 'text/csv' });
      downloadBlob(blob, filename);
    }

    function downloadBlob(blob, filename) {
      console.log('Starting download for:', filename);
      console.log('Blob type:', blob.type);
      console.log('Blob size:', blob.size);
      
      // Single download method to prevent duplicate popups
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.style.display = 'none';
      
      // Add to DOM and trigger
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Cleanup
      setTimeout(() => {
        URL.revokeObjectURL(url);
      }, 2000);
      
      console.log('Download triggered for:', filename);
    }
    
    // Parse forecast data and create chart
    async function parseForecastAndCreateChart(blob, outputFormat) {
      try {
        let forecastData = [];
        
        if (outputFormat === 'xlsx') {
          // Parse Excel file
          const arrayBuffer = await blob.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          forecastData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        } else {
          // Parse CSV file
          const text = await blob.text();
          const lines = text.split('\n');
          forecastData = lines.map(line => line.split(',').map(cell => cell.trim()));
        }
        
        // Remove header row and empty rows
        forecastData = forecastData.filter(row => row.length >= 3 && row[0] !== 'Date');
        
        // Aggregate data by date (sum all items for each date)
        const aggregatedData = {};
        forecastData.forEach(row => {
          const date = row[0];
          const quantity = parseFloat(row[2]) || 0;
          
          if (aggregatedData[date]) {
            aggregatedData[date] += quantity;
          } else {
            aggregatedData[date] = quantity;
          }
        });
        
        // Convert to arrays for chart with proper date sorting
        const dates = Object.keys(aggregatedData).sort((a, b) => {
          // Parse dates in DD/MM/YYYY or MM/DD/YYYY format
          const parseDate = (dateStr) => {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
              // Check if it's DD/MM/YYYY (EUR) or MM/DD/YYYY (US) format
              const day = parseInt(parts[0]);
              const month = parseInt(parts[1]);
              const year = parseInt(parts[2]);
              
              // If day > 12, it's likely DD/MM/YYYY format
              if (day > 12) {
                return new Date(year, month - 1, day);
              } else {
                // Assume MM/DD/YYYY format
                return new Date(year, month - 1, day);
              }
            }
            return new Date(dateStr);
          };
          
          return parseDate(a) - parseDate(b);
        });
        const quantities = dates.map(date => aggregatedData[date]);
        
        // Create chart
        createForecastChart(dates, quantities);
        
        // Show summary
        showForecastSummary(aggregatedData);
        
        // Show the preview and download options
        document.getElementById('forecastPreview').style.display = 'block';
        document.getElementById('downloadOptions').style.display = 'block';
        
        // Enhanced smooth scroll to the forecast preview with iPhone-style animation
        setTimeout(() => {
          const previewElement = document.getElementById('forecastPreview');
          const offset = 80; // More space above the preview
          const elementPosition = previewElement.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - offset;
          
          // Use a more pronounced smooth scroll
          const startPosition = window.pageYOffset;
          const distance = offsetPosition - startPosition;
          const duration = 1200; // Longer duration for more visible animation
          let start = null;
          
          function animation(currentTime) {
            if (start === null) start = currentTime;
            const timeElapsed = currentTime - start;
            const run = easeInOutCubic(timeElapsed, startPosition, distance, duration);
            window.scrollTo(0, run);
            if (timeElapsed < duration) requestAnimationFrame(animation);
          }
          
          // Easing function for smooth iPhone-style animation
          function easeInOutCubic(t, b, c, d) {
            t /= d / 2;
            if (t < 1) return c / 2 * t * t * t + b;
            t -= 2;
            return c / 2 * (t * t * t + 2) + b;
          }
          
          requestAnimationFrame(animation);
        }, 500);
        
      } catch (error) {
        console.error('Error parsing forecast data:', error);
      }
    }
    
    function createForecastChart(dates, quantities) {
      const ctx = document.getElementById('forecastChart').getContext('2d');
      // Destroy existing chart if it exists and is a Chart.js instance
      if (window.forecastChart && typeof window.forecastChart.destroy === 'function') {
        window.forecastChart.destroy();
      }
      window.forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Forecast Quantity',
            data: quantities,
            borderColor: 'rgb(99, 102, 241)',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: 'rgb(99, 102, 241)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgb(99, 102, 241)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return 'Date: ' + context[0].label;
                },
                label: function(context) {
                  return 'Forecast: ' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Time Period',
                color: 'var(--text-secondary)',
                font: {
                  size: 12,
                  weight: '500'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: 'var(--text-secondary)',
                maxTicksLimit: 8
              }
            },
            y: {
              title: {
                display: true,
                text: 'Forecast Quantity',
                color: 'var(--text-secondary)',
                font: {
                  size: 12,
                  weight: '500'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: 'var(--text-secondary)',
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }
    
    function showForecastSummary(aggregatedData) {
      const quantities = Object.values(aggregatedData);
      const total = quantities.reduce((sum, qty) => sum + qty, 0);
      const average = total / quantities.length;
      const min = Math.min(...quantities);
      const max = Math.max(...quantities);
      const periods = quantities.length;
      
      const summaryText = `
        <strong>Total Forecast:</strong> ${total.toLocaleString()} units<br>
        <strong>Average per Period:</strong> ${average.toLocaleString(undefined, {maximumFractionDigits: 0})} units<br>
        <strong>Range:</strong> ${min.toLocaleString()} - ${max.toLocaleString()} units<br>
        <strong>Forecast Periods:</strong> ${periods} periods
      `;
      
      document.getElementById('summaryText').innerHTML = summaryText;
    }

    async function downloadForecast(format) {
      if (!window.forecastSettings) {
        showError('No forecast data available. Please generate a forecast first.');
        return;
      }

      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.disabled = true;
      downloadBtn.innerHTML = '<i class="fas fa-spinner spinning"></i> Generating...';

      try {
        const res = await fetch('/api/forecast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            ...window.forecastSettings,
            exportFormat: format
          })
        });
        
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || "Download generation failed");
        }
        
        const blob = await res.blob();
        const filename = format === 'xlsx' ? 'AI_generated_Forecast.xlsx' : 'AI_generated_Forecast.csv';
        
        downloadBlob(blob, filename);
        showSuccess(`${format.toUpperCase()} forecast downloaded successfully!`);
        
      } catch (e) {
        console.error('Download error:', e);
        showError('Error: ' + e.message);
      } finally {
        downloadBtn.disabled = false;
        downloadBtn.innerHTML = originalText;
      }
    }

    function downloadXLSX(csvText, filename) {
      const rows = csvText.split('\n').map(r => r.split(',').map(c => c.trim()));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Forecast');
      XLSX.writeFile(wb, filename);
    }

    // File upload visual feedback
    document.querySelectorAll('input[type="file"]').forEach(input => {
      input.addEventListener('change', function() {
        const label = this.parentElement.querySelector('.file-upload-label');
        if (this.files.length > 0) {
          label.classList.add('success');
          label.innerHTML = `<i class="fas fa-check"></i><span>${this.files[0].name}</span>`;
        } else {
          label.classList.remove('success');
          const defaultText = this.id === 'historicalFile' ? 'Choose file or drag and drop' : 'Choose file or drag and drop';
          label.innerHTML = `<i class="fas fa-file-upload"></i><span>${defaultText}</span>`;
        }
      });
    });

    // Drag and drop functionality
    document.querySelectorAll('.file-upload-label').forEach(label => {
      label.addEventListener('dragover', (e) => {
        e.preventDefault();
        label.style.borderColor = 'var(--primary-color)';
        label.style.background = 'rgb(99 102 241 / 0.1)';
      });

      label.addEventListener('dragleave', (e) => {
        e.preventDefault();
        label.style.borderColor = 'var(--border-color)';
        label.style.background = 'var(--bg-color)';
      });

      label.addEventListener('drop', (e) => {
        e.preventDefault();
        label.style.borderColor = 'var(--border-color)';
        label.style.background = 'var(--bg-color)';
        
        const input = label.parentElement.querySelector('input[type="file"]');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          input.files = files;
          input.dispatchEvent(new Event('change'));
        }
      });
    });

    // Supabase config
    const SUPABASE_URL = 'https://iayecqndmobjswtzoldb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlheWVjcW5kbW9ianN3dHpvbGRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjU1MjUsImV4cCI6MjA2NzgwMTUyNX0.FpndmbB-t9dvJsUFUX8l4VdLlbP4BZ1a425116UF10Q';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Auth modal logic
    const authModal = document.getElementById('authModal');
    const authForm = document.getElementById('authForm');
    const authTitle = document.getElementById('authTitle');
    const authError = document.getElementById('authError');
    const authSubmitBtn = document.getElementById('authSubmitBtn');
    const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
    let isSignIn = true;

    function showAuthModal() {
      authModal.style.display = 'flex';
      authError.style.display = 'none';
      authForm.reset();
      authTitle.textContent = isSignIn ? 'Sign In' : 'Register';
      authSubmitBtn.textContent = isSignIn ? 'Sign In' : 'Register';
      toggleAuthModeBtn.textContent = isSignIn ? "Don't have an account? Register" : 'Already have an account? Sign In';
    }
    function hideAuthModal() {
      authModal.style.display = 'none';
    }
    toggleAuthModeBtn.onclick = function() {
      isSignIn = !isSignIn;
      showAuthModal();
    };
    authForm.onsubmit = async function(e) {
      e.preventDefault();
      authError.style.display = 'none';
      authSubmitBtn.disabled = true;
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      try {
        let result;
        if (isSignIn) {
          result = await supabase.auth.signInWithPassword({ email, password });
        } else {
          result = await supabase.auth.signUp({ email, password });
        }
        if (result.error) throw result.error;
        hideAuthModal();
        onAuthStateChanged();
      } catch (err) {
        authError.textContent = err.message;
        authError.style.display = 'block';
      } finally {
        authSubmitBtn.disabled = false;
      }
    };
    // Show login modal if not logged in
    async function onAuthStateChanged() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        showAuthModal();
        document.getElementById('forecastPage').classList.add('hidden');
        document.getElementById('homePage').classList.remove('hidden');
        document.getElementById('logoutBtn')?.remove();
      } else {
        hideAuthModal();
        // Add logout button if not present
        if (!document.getElementById('logoutBtn')) {
          const btn = document.createElement('button');
          btn.className = 'btn btn-back';
          btn.id = 'logoutBtn';
          btn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
          btn.onclick = async function() {
            await supabase.auth.signOut();
            onAuthStateChanged();
          };
          document.querySelector('.site-logo').parentElement.appendChild(btn);
        }
      }
    }
    // Listen for auth state changes
    supabase.auth.onAuthStateChange((_event, _session) => {
      onAuthStateChanged();
    });
    // On page load, check auth
    window.addEventListener('DOMContentLoaded', onAuthStateChanged);

    // Restrict forecast functionality
    const origShowPage = showPage;
    showPage = function(id) {
      supabase.auth.getSession().then(({ data: { session } }) => {
        if (!session && id === 'forecastPage') {
          showAuthModal();
          return;
        }
        origShowPage(id);
      });
    };
  </script>
</body>
</html>
