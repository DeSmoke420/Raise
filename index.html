
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Forecast Intelligence Platform</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary-color: #10b981;
      --accent-color: #f59e0b;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: var(--font-family);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      padding: 3rem;
      width: 100%;
      max-width: 700px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .logo i {
      font-size: 1.75rem;
      color: white;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 400;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      width: 100%;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--bg-color);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }

    .btn-back {
      background: transparent;
      color: var(--text-secondary);
      border: 2px solid var(--border-color);
      font-weight: 500;
    }

    .btn-back:hover {
      background: var(--bg-color);
      color: var(--text-primary);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .field {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .input-group {
      position: relative;
    }

    .input-group i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      z-index: 1;
    }

    input[type="file"], select, input[type="number"] {
      width: 100%;
      padding: 0.875rem 1rem;
      padding-left: 2.5rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      background: var(--card-bg);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    input[type="file"] {
      padding-left: 1rem;
    }

    input[type="file"]::-webkit-file-upload-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      margin-right: 1rem;
      font-weight: 500;
    }

    input[type="file"]::-webkit-file-upload-button:hover {
      background: var(--primary-dark);
    }

    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .hidden {
      display: none !important;
    }

    /* Info Boxes */
    .info-box {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .info-box h3 {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-box p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .info-box.warning {
      background: rgb(245 158 11 / 0.1);
      border-color: var(--warning-color);
    }

    .info-box.warning h3 {
      color: var(--warning-color);
    }

    .info-box.success {
      background: rgb(16 185 129 / 0.1);
      border-color: var(--secondary-color);
    }

    .info-box.success h3 {
      color: var(--secondary-color);
    }

    /* Progress Bar */
    .progress-container {
      margin: 1rem 0;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border-color);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 2rem;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--shadow-xl);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .modal-text {
      font-size: 1.1rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .modal-details {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-color);
      border-radius: var(--radius-md);
      text-align: left;
      font-size: 0.9rem;
      color: var(--text-secondary);
      max-height: 200px;
      overflow-y: auto;
    }

    .modal-buttons {
      margin-top: 1.5rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .card {
        padding: 2rem;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      h1 {
        font-size: 1.75rem;
      }
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }

    /* File upload styling */
    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-lg);
      background: var(--bg-color);
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-upload-label:hover {
      border-color: var(--primary-color);
      background: rgb(99 102 241 / 0.05);
    }

    .file-upload-label i {
      font-size: 1.25rem;
    }

    /* Success/Error states */
    .success {
      border-color: var(--secondary-color) !important;
      background: rgb(16 185 129 / 0.05) !important;
    }

    .error {
      border-color: var(--error-color) !important;
      background: rgb(239 68 68 / 0.05) !important;
    }

    /* Data Preview */
    .data-preview {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-color);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      display: none;
    }

    .data-preview h4 {
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .data-preview table {
      width: 100%;
      font-size: 0.8rem;
      border-collapse: collapse;
    }

    .data-preview th,
    .data-preview td {
      padding: 0.25rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .data-preview th {
      font-weight: 600;
      color: var(--text-primary);
    }

    .data-preview td {
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Home Page -->
    <div class="card fade-in" id="homePage">
      <div class="header">
        <div class="logo">
          <i class="fas fa-chart-line"></i>
        </div>
        <h1>AI Forecast Intelligence</h1>
        <p class="subtitle">Advanced forecasting powered by machine learning</p>
      </div>
      
      <button class="btn btn-primary" onclick="showPage('forecastPage')">
        <i class="fas fa-magic"></i>
        Generate Forecast
      </button>
    </div>

    <!-- Forecast Page -->
    <div class="card hidden slide-in" id="forecastPage">
      <div class="header">
        <h1>Generate Forecast</h1>
        <p class="subtitle">Upload your historical data to generate AI-powered forecasts</p>
      </div>
      
      <div class="info-box">
        <h3><i class="fas fa-info-circle"></i>Data Requirements</h3>
        <p>Your CSV/Excel file should contain columns for: <strong>Date</strong> (e.g., Date, period, time), <strong>Item ID</strong> (e.g., Item, product, sku), and <strong>Quantity</strong> (e.g., Quantity, sales, demand). The system will automatically detect these columns.</p>
      </div>
      
      <div class="field">
        <label for="historicalFile">
          <i class="fas fa-upload"></i> Historical Data
        </label>
        <div class="file-upload">
          <input type="file" id="historicalFile" accept=".xlsx,.xls,.csv" onchange="previewData(this)">
          <div class="file-upload-label">
            <i class="fas fa-file-upload"></i>
            <span>Choose file or drag and drop</span>
          </div>
        </div>
        <div class="data-preview" id="dataPreview">
          <h4>Data Preview</h4>
          <div id="previewTable"></div>
        </div>
      </div>
      
      <div class="grid">
        <div class="field">
          <label for="timeUnit">
            <i class="fas fa-clock"></i> Time Unit
          </label>
          <div class="input-group">
            <i class="fas fa-calendar"></i>
            <select id="timeUnit">
              <option value="monthly">Monthly</option>
              <option value="weekly">Weekly</option>
              <option value="daily">Daily</option>
            </select>
          </div>
        </div>
        
        <div class="field">
          <label for="periodCount">
            <i class="fas fa-hashtag"></i> Forecast Periods
          </label>
          <div class="input-group">
            <i class="fas fa-chart-bar"></i>
            <input type="number" id="periodCount" min="1" max="120" placeholder="e.g. 12" value="12">
          </div>
        </div>
      </div>
      
      <div class="field">
        <label for="outputFormat">
          <i class="fas fa-download"></i> Output Format
        </label>
        <div class="input-group">
          <i class="fas fa-file"></i>
          <select id="outputFormat">
            <option value="xlsx">Excel (.xlsx)</option>
            <option value="csv">Comma Separated Values (.csv)</option>
          </select>
        </div>
      </div>
      
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Processing...</div>
      </div>
      
      <button class="btn btn-primary" onclick="generateForecast()" id="generateBtn">
        <i class="fas fa-rocket"></i>
        Generate Forecast
      </button>
      
      <button class="btn btn-back" onclick="showPage('homePage')">
        <i class="fas fa-arrow-left"></i>
        Back to Home
      </button>
    </div>


  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="spinner" id="modalSpinner"></div>
      <p class="modal-text" id="modalText">Processing your request<span id="dots">.</span></p>
      <div class="modal-details" id="modalDetails" style="display: none;"></div>
      <div class="modal-buttons" id="modalButtons" style="display: none;">
        <button class="btn btn-back" onclick="hideModal()">
          <i class="fas fa-arrow-left"></i>
          Back
        </button>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById('modal');
    const dots = document.getElementById('dots');
    let dotInterval;

    function showPage(id) {
      document.querySelectorAll('.card').forEach(div => {
        div.classList.add('hidden');
        div.classList.remove('fade-in', 'slide-in');
      });
      const targetPage = document.getElementById(id);
      targetPage.classList.remove('hidden');
      targetPage.classList.add(id === 'homePage' ? 'fade-in' : 'slide-in');
      
      // Reset form states
      if (id === 'forecastPage') {
        resetForecastForm();
      }
    }

    function resetForecastForm() {
      document.getElementById('historicalFile').value = '';
      document.getElementById('periodCount').value = '12';
      document.getElementById('dataPreview').style.display = 'none';
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('generateBtn').disabled = false;
      updateFileLabel('historicalFile', 'Choose file or drag and drop');
    }



    function updateFileLabel(inputId, defaultText) {
      const input = document.getElementById(inputId);
      const label = input.parentElement.querySelector('.file-upload-label');
      label.classList.remove('success', 'error');
      label.innerHTML = `<i class="fas fa-file-upload"></i><span>${defaultText}</span>`;
    }

    function showModal(msg, details = null, showButtons = false) {
      document.getElementById('modalText').textContent = msg;
      const detailsDiv = document.getElementById('modalDetails');
      const buttonsDiv = document.getElementById('modalButtons');
      const spinner = document.getElementById('modalSpinner');
      
      if (details) {
        detailsDiv.innerHTML = details;
        detailsDiv.style.display = 'block';
      } else {
        detailsDiv.style.display = 'none';
      }
      
      if (showButtons) {
        buttonsDiv.style.display = 'flex';
        spinner.style.display = 'none';
        clearInterval(dotInterval);
      } else {
        buttonsDiv.style.display = 'none';
        spinner.style.display = 'block';
        let count = 1;
        dotInterval = setInterval(() => {
          dots.textContent = '.'.repeat(count);
          count = count === 3 ? 1 : count + 1;
        }, 500);
      }
      
      modal.style.display = 'flex';
    }

    function hideModal() {
      modal.style.display = 'none';
      clearInterval(dotInterval);
    }

    function showProgress(show = true) {
      const container = document.getElementById('progressContainer');
      container.style.display = show ? 'block' : 'none';
      if (show) {
        simulateProgress();
      }
    }

    function simulateProgress() {
      const fill = document.getElementById('progressFill');
      const text = document.getElementById('progressText');
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        fill.style.width = progress + '%';
        text.textContent = `Processing... ${Math.round(progress)}%`;
        if (progress >= 90) {
          clearInterval(interval);
        }
      }, 500);
    }

    function previewData(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const wb = XLSX.read(e.target.result, { type: 'binary' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          
          if (data.length > 0) {
            const headers = data[0];
            const preview = data.slice(1, 6); // Show first 5 rows
            
            let tableHTML = '<table><thead><tr>';
            headers.forEach(header => {
              tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            preview.forEach(row => {
              tableHTML += '<tr>';
              row.forEach((cell, index) => {
                // Check if this might be a date column (first column or contains date-like headers)
                const header = headers[index] ? headers[index].toLowerCase() : '';
                const isDateColumn = header.includes('date') || header.includes('time') || header.includes('period') || index === 0;
                
                let displayValue = cell || '';
                
                // Try to format as date if it's a number and might be a date column
                if (isDateColumn && typeof cell === 'number' && cell > 1000) {
                  try {
                    // Convert Excel serial number to date
                    const excelDate = new Date((cell - 25569) * 86400 * 1000);
                    if (!isNaN(excelDate.getTime())) {
                      displayValue = excelDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short'
                      });
                    }
                  } catch (dateError) {
                    // If date conversion fails, keep original value
                    console.log('Date conversion failed for:', cell);
                  }
                }
                
                tableHTML += `<td>${displayValue}</td>`;
              });
              tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            
            document.getElementById('previewTable').innerHTML = tableHTML;
            document.getElementById('dataPreview').style.display = 'block';
          }
        } catch (error) {
          console.error('Error previewing data:', error);
        }
      };
      reader.readAsBinaryString(file);
    }

    function readFileAsCSV(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const csv = XLSX.utils.sheet_to_csv(sheet, { FS: ',', RS: '\n', strip: true });
            resolve(csv);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = e => reject(e);
        reader.readAsBinaryString(file);
      });
    }

    async function generateForecast() {
      const file = document.getElementById('historicalFile').files[0];
      const timeUnit = document.getElementById('timeUnit').value;
      const periods = document.getElementById('periodCount').value.trim();
      const outputFormat = document.getElementById('outputFormat').value;

      if (!file) {
        showError('Please upload a historical data file');
        return;
      }

      if (!periods || periods < 1 || periods > 120) {
        showError('Please specify a valid number of periods (1-120)');
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      generateBtn.disabled = true;
      showProgress(true);
      showModal("Analyzing your data and generating forecasts...");

      try {
        const csv = await readFileAsCSV(file);
        console.log('Sending forecast request...');
        const res = await fetch('/api/forecast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ csv, timeUnit, periods, exportFormat: outputFormat })
        });
        
        console.log('Response status:', res.status);
        console.log('Response headers:', Object.fromEntries(res.headers.entries()));
        
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || "Forecast generation failed");
        }
        
        // Handle single file response
        const contentType = res.headers.get('content-type');
        console.log('Content-Type:', contentType);
        const blob = await res.blob();
        console.log('Blob size:', blob.size);
        
        if (contentType && contentType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')) {
          // Excel file
          console.log('Downloading Excel file...');
          downloadBlob(blob, 'AI_generated_Forecast.xlsx');
          showSuccess('Excel forecast generated successfully! Check your downloads folder or browser downloads.');
        } else if (contentType && contentType.includes('text/csv')) {
          // CSV file
          console.log('Downloading CSV file...');
          downloadBlob(blob, 'AI_generated_Forecast.csv');
          showSuccess('CSV forecast generated successfully! Check your downloads folder or browser downloads.');
        } else {
          // Fallback
          console.log('Downloading fallback file...');
          downloadBlob(blob, outputFormat === 'xlsx' ? 'AI_generated_Forecast.xlsx' : 'AI_generated_Forecast.csv');
          showSuccess('Forecast generated successfully! Check your downloads folder or browser downloads.');
        }
      } catch (e) {
        console.error('Forecast error:', e);
        showError('Error: ' + e.message);
      } finally {
        generateBtn.disabled = false;
        showProgress(false);
        hideModal();
      }
    }



    function showError(message) {
      showModal('Error', `<div style="color: var(--error-color); font-weight: 600;">${message}</div>`, true);
    }

    function showSuccess(message) {
      showModal('Success', `<div style="color: var(--secondary-color); font-weight: 600;">${message}</div>`);
      setTimeout(hideModal, 2000);
    }

    function downloadCSV(text, filename) {
      const blob = new Blob([text], { type: 'text/csv' });
      downloadBlob(blob, filename);
    }

    function downloadBlob(blob, filename) {
      console.log('Starting download for:', filename);
      console.log('Blob type:', blob.type);
      console.log('Blob size:', blob.size);
      
      // Method 1: Direct download with proper MIME type
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.style.display = 'none';
      
      // Add to DOM and trigger
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Method 2: If Method 1 fails, try opening in new window
      setTimeout(() => {
        try {
          window.open(url, '_blank');
        } catch (e) {
          console.error('Window open failed:', e);
        }
      }, 500);
      
      // Cleanup
      setTimeout(() => {
      URL.revokeObjectURL(url);
      }, 2000);
      
      console.log('Download methods triggered for:', filename);
    }

    function downloadXLSX(csvText, filename) {
      const rows = csvText.split('\n').map(r => r.split(',').map(c => c.trim()));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Forecast');
      XLSX.writeFile(wb, filename);
    }

    // File upload visual feedback
    document.querySelectorAll('input[type="file"]').forEach(input => {
      input.addEventListener('change', function() {
        const label = this.parentElement.querySelector('.file-upload-label');
        if (this.files.length > 0) {
          label.classList.add('success');
          label.innerHTML = `<i class="fas fa-check"></i><span>${this.files[0].name}</span>`;
        } else {
          label.classList.remove('success');
          const defaultText = this.id === 'historicalFile' ? 'Choose file or drag and drop' : 'Choose file or drag and drop';
          label.innerHTML = `<i class="fas fa-file-upload"></i><span>${defaultText}</span>`;
        }
      });
    });

    // Drag and drop functionality
    document.querySelectorAll('.file-upload-label').forEach(label => {
      label.addEventListener('dragover', (e) => {
        e.preventDefault();
        label.style.borderColor = 'var(--primary-color)';
        label.style.background = 'rgb(99 102 241 / 0.1)';
      });

      label.addEventListener('dragleave', (e) => {
        e.preventDefault();
        label.style.borderColor = 'var(--border-color)';
        label.style.background = 'var(--bg-color)';
      });

      label.addEventListener('drop', (e) => {
        e.preventDefault();
        label.style.borderColor = 'var(--border-color)';
        label.style.background = 'var(--bg-color)';
        
        const input = label.parentElement.querySelector('input[type="file"]');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          input.files = files;
          input.dispatchEvent(new Event('change'));
        }
      });
    });
  </script>
</body>
</html>
