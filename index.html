<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Forecast Intelligence Platform</title>
  <link rel="icon" type="image/png" href="static/logo2.png?v=2" sizes="512x512">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary-color: #10b981;
      --accent-color: #f59e0b;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: var(--font-family);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      margin-top: -5vh; /* Move the block higher to center it better */
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      padding: 3rem;
      width: 100%;
      max-width: 700px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .header {
      text-align: center;
      margin-bottom: 2.5rem;
      position: relative;
      z-index: 1;
    }

    .logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .logo i {
      font-size: 1.75rem;
      color: white;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 400;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      width: 100%;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--bg-color);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }

    .btn-back {
      background: transparent;
      color: var(--text-secondary);
      border: 2px solid var(--border-color);
      font-weight: 500;
    }

    .btn-back:hover {
      background: var(--bg-color);
      color: var(--text-primary);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Custom spinning animation for download buttons */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .spinning {
      animation: spin 1s linear infinite;
    }

    .download-loading {
      position: relative;
    }

    .download-loading i {
      animation: spin 1s linear infinite;
    }

    /* Enhanced loading state for download buttons */
    .btn:disabled .spinning {
      animation: spin 1s linear infinite, pulse 2s ease-in-out infinite;
    }

    .field {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .input-group {
      position: relative;
    }

    .input-group i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      z-index: 1;
    }

    input[type="file"], select, input[type="number"] {
      width: 100%;
      padding: 0.875rem 1rem;
      padding-left: 2.5rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      background: var(--card-bg);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    input[type="file"] {
      padding-left: 1rem;
    }

    input[type="file"]::-webkit-file-upload-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      margin-right: 1rem;
      font-weight: 500;
    }

    input[type="file"]::-webkit-file-upload-button:hover {
      background: var(--primary-dark);
    }

    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
    }
    
    /* Ensure select dropdown text doesn't overlap with icons */
    select {
      text-indent: 0;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
      padding-right: 2.5rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    


    .hidden {
      display: none !important;
    }

    /* Info Boxes */
    .info-box {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .info-box h3 {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-box p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .info-box.warning {
      background: rgb(245 158 11 / 0.1);
      border-color: var(--warning-color);
    }

    .info-box.warning h3 {
      color: var(--warning-color);
    }

    .info-box.success {
      background: rgb(16 185 129 / 0.1);
      border-color: var(--secondary-color);
    }

    .info-box.success h3 {
      color: var(--secondary-color);
    }

    /* Progress Bar */
    .progress-container {
      margin: 1rem 0;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border-color);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 2rem;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--shadow-xl);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .modal-text {
      font-size: 1.1rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .modal-details {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-color);
      border-radius: var(--radius-md);
      text-align: left;
      font-size: 0.9rem;
      color: var(--text-secondary);
      max-height: 200px;
      overflow-y: auto;
    }

    .modal-buttons {
      margin-top: 1.5rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .card {
        padding: 2rem;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      h1 {
        font-size: 1.75rem;
      }
      
      /* Mobile-specific header adjustments */
      .header {
        margin-bottom: 2rem;
      }
      
      .logo {
        width: 56px;
        height: 56px;
        margin-bottom: 1rem;
      }
      
      .logo i {
        font-size: 1.5rem;
      }
      
      /* Ensure proper spacing between header and form fields */
      .header + .info-box,
      .header + .field {
        margin-top: 1rem;
      }
      
      /* Adjust input group positioning for mobile */
      .input-group {
        margin-bottom: 0.5rem;
      }
      
      /* Ensure select dropdowns don't get cut off */
      select {
        max-height: 200px;
      }
      
      /* Additional mobile spacing fixes */
      .field {
        margin-bottom: 1.25rem;
      }
      
      /* Ensure form elements have proper spacing from header */
      #forecastPage .header {
        margin-bottom: 1.5rem;
      }
      
      /* Prevent any potential overlap with absolute positioned elements */
      .input-group i {
        z-index: 2;
      }
      
      /* Fix input field icon spacing on mobile */
      input[type="file"], select, input[type="number"] {
        padding-left: 3rem;
      }
      
      .input-group i {
        left: 1.25rem;
        font-size: 0.9rem;
      }
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }

    /* File upload styling */
    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-lg);
      background: var(--bg-color);
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-upload-label:hover {
      border-color: var(--primary-color);
      background: rgb(99 102 241 / 0.05);
    }

    .file-upload-label i {
      font-size: 1.25rem;
    }

    /* Success/Error states */
    .success {
      border-color: var(--secondary-color) !important;
      background: rgb(16 185 129 / 0.05) !important;
    }

    .error {
      border-color: var(--error-color) !important;
      background: rgb(239 68 68 / 0.05) !important;
    }

    /* Data Preview */
    .data-preview {
      margin-top: 0.5rem;
      padding: 1rem;
      background: var(--bg-color);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      display: none;
    }

    .data-preview h4 {
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .data-preview table {
      width: 100%;
      font-size: 0.8rem;
      border-collapse: collapse;
    }

    .data-preview th,
    .data-preview td {
      padding: 0.25rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .data-preview th {
      font-weight: 600;
      color: var(--text-primary);
    }

    .data-preview td {
      color: var(--text-secondary);
    }
    
    /* Forecast Preview Chart */
    .forecast-preview {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--bg-color);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      display: none;
    }
    
    .forecast-preview h3 {
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    .chart-summary {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }
    
    .chart-summary h4 {
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .chart-summary p {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin: 0.25rem 0;
    }
    
    .download-options {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--bg-color);
      border-radius: var(--radius-lg);
      border: 2px solid var(--border-color);
    }
    
    .download-options h4 {
      margin-bottom: 1rem;
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .download-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .download-buttons .btn {
      flex: 1;
      min-width: 160px;
      max-width: 220px;
      font-size: 0.9rem;
      padding: 0.75rem 1rem;
    }
    
    /* Download buttons: both grey by default, purple on hover */
    .download-buttons .btn {
      background: var(--bg-color);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      box-shadow: var(--shadow-md);
      transition: background 0.2s, color 0.2s, transform 0.15s, box-shadow 0.2s, border-color 0.2s;
    }
    .download-buttons .btn:hover {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-dark);
    }
    
    @media (max-width: 768px) {
      .download-buttons {
        flex-direction: column;
      }
      .download-buttons .btn {
        min-width: auto;
        max-width: none;
        font-size: 0.85rem;
        padding: 0.7rem 0.9rem;
      }
    }
    .site-logo {
      position: fixed;
      top: 24px;
      left: 24px;
      z-index: 1000;
      display: flex;
      align-items: center;
      text-decoration: none;
    }
    .site-logo img {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(99,102,241,0.10);
      background: #fff;
      padding: 8px;
      transition: box-shadow 0.2s;
    }
    .site-logo:hover img {
      box-shadow: 0 4px 16px rgba(99,102,241,0.18);
    }
    @media (max-width: 768px) {
      .site-logo {
        top: 10px;
        left: 10px;
      }
      .site-logo img {
        width: 60px;
        height: 60px;
        padding: 5px;
      }
      
      .auth-header {
        top: 10px;
        right: 10px;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .auth-buttons {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .auth-buttons .btn {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
      }
      
      .user-info {
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }
    }
    
    /* Auth Header Styles */
    .auth-header {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .auth-buttons {
      display: flex;
      gap: 0.75rem;
    }
    
    .auth-buttons .btn {
      font-size: 0.9rem;
      padding: 0.6rem 1rem;
      margin: 0;
      background: white;
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      transition: all 0.2s ease;
      min-width: 100px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .auth-buttons .btn:hover {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-dark);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: rgba(255, 255, 255, 0.95);
      padding: 0.5rem 1rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
    }
    
    .user-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .user-info .btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
      margin: 0;
    }
    
    /* User Dropdown Styles */
    .user-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .user-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card-bg);
      min-width: 200px;
      box-shadow: var(--shadow-lg);
      border-radius: var(--radius-lg);
      z-index: 1000;
      margin-top: 0.5rem;
      border: 1px solid var(--border-color);
    }
    
    .user-dropdown-content.show {
      display: block;
    }
    
    .user-email {
      padding: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      background: rgba(99, 102, 241, 0.05);
    }
    
    .dropdown-divider {
      height: 1px;
      background: var(--border-color);
      margin: 0.5rem 0;
    }
    
    .dropdown-item {
      width: 100%;
      padding: 0.75rem 1rem;
      border: none;
      background: none;
      color: var(--text-primary);
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.2s ease;
    }
    
    .dropdown-item:hover {
      background: rgba(99, 102, 241, 0.1);
    }
    
    .dropdown-item i {
      width: 16px;
      color: var(--text-secondary);
    }
    
    #dropdownArrow {
      transition: transform 0.2s ease;
      margin-left: 0.5rem;
    }
    
    /* Pricing Plans Styles */
    .pricing-plans {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    
    .pricing-card {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: 2rem;
      text-align: center;
      position: relative;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
    }
    
    .pricing-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
    }
    
    .pricing-card.featured {
      border-color: var(--primary-color);
      box-shadow: var(--shadow-lg);
      transform: scale(1.05);
    }
    
    .pricing-card.trial {
      border-color: var(--secondary-color);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.1));
    }
    
    .plan-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-lg);
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: var(--shadow-md);
    }
    
    .trial-badge {
      background: linear-gradient(135deg, var(--secondary-color), #059669);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 0.5rem;
      display: inline-block;
    }
    
    .plan-header h4 {
      color: var(--text-primary);
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .price {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }
    
    .period {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }
    
    .plan-features {
      list-style: none;
      padding: 0;
      margin: 0 0 2rem 0;
      text-align: left;
    }
    
    .plan-features li {
      padding: 0.5rem 0;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .plan-features li i {
      color: var(--secondary-color);
      font-size: 0.9rem;
      min-width: 16px;
    }
    
    .pricing-card .btn {
      width: 100%;
      margin: 0;
    }
    
    @media (max-width: 768px) {
      .pricing-plans {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .pricing-card {
        padding: 1.5rem;
      }
      
      .pricing-card.featured {
        transform: none;
      }
      
      .price {
        font-size: 2rem;
      }
      
      #pricingModal .modal-content {
        max-width: 95%;
        margin: 1rem;
        padding: 1.5rem;
      }
      
      #pricingModal .pricing-plans {
        grid-template-columns: 1fr;
      }
    }

    .sticky-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 64px;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      z-index: 1000;
    }
    .logo-container .logo {
      height: 40px;
    }
    .auth-buttons button {
      margin-left: 12px;
    }
    main, .main-content {
      padding-top: 110px; /* header height + margin */
    }
  </style>
</head>
<body>
  <main class="main-content">
  <a href="/" class="site-logo">
    <img src="static/logo.png" alt="r4ise logo" />
  </a>
  
  <!-- Auth Header -->
  <div class="auth-header">
    <div class="auth-buttons" id="authButtons">
      <button class="btn" onclick="toggleAuthModal()">
        <i class="fas fa-sign-in-alt"></i>
        Sign In
      </button>
      <button class="btn" onclick="toggleAuthModal('signup')">
        <i class="fas fa-user-plus"></i>
        Sign Up
      </button>
    </div>
    <div class="user-info" id="userInfo" style="display: none;">
      <div class="user-dropdown">
        <button class="btn btn-primary" onclick="toggleUserDropdown()">
          <i class="fas fa-user"></i>
          My Account
          <i class="fas fa-chevron-down" id="dropdownArrow"></i>
        </button>
        <div class="user-dropdown-content" id="userDropdown">
          <div class="user-email" id="userName"></div>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <!-- Home Page -->
    <div class="card fade-in" id="homePage">
      <div class="header">
        <div class="logo">
          <i class="fas fa-chart-line"></i>
        </div>
        <h1>AI Forecast Intelligence</h1>
        <p class="subtitle">Advanced forecasting powered by machine learning</p>
      </div>
      
      <button class="btn btn-primary" onclick="showPage('forecastPage')">
        <i class="fas fa-magic"></i>
        Generate Forecast
      </button>
    </div>

    <!-- Forecast Page -->
    <div class="card hidden slide-in" id="forecastPage">
      <div class="header">
        <h1>Generate Forecast</h1>
        <p class="subtitle">Upload your historical data to generate AI-powered forecasts</p>
      </div>
      
      <!-- Subscription Status -->
      <div class="subscription-status" id="subscriptionStatus" style="display: none;">
        <div class="info-box success">
          <h3><i class="fas fa-check-circle"></i> Active Subscription</h3>
          <p id="subscriptionDetails">Loading subscription details...</p>
        </div>
      </div>
      
      <!-- Payment Required -->
        <!-- <div class="payment-required" id="paymentRequired" style="display: none;">
        <div class="info-box warning">
          <h3><i class="fas fa-lock"></i> Subscription Required</h3>
          <p>You need an active subscription to generate forecasts. <button class="btn btn-primary" onclick="showPricingModal()" style="margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">Choose a Plan</button></p>
        </div>
        </div> -->
      
      <div class="info-box">
        <h3><i class="fas fa-info-circle"></i>Data Requirements</h3>
        <p>Your Excel file (.xlsx) must contain exactly three columns with the following headers: <strong>"Date"</strong>, <strong>"Item"</strong>, and <strong>"Quantity"</strong>. The <strong>"Date"</strong> column must be in a valid Excel date format such as <em>dd/mm/yyyy, mm/dd/yyyy, or mm/yyyy</em>. The <strong>"Item"</strong> column can be either text or a number. The <strong>"Quantity"</strong> column must contain numeric values only, with or without decimals, and should not include any thousands separators (e.g., write "1000" instead of "1,000"). Both European (e.g., "1000,5") and US (e.g., "1000.5") decimal formats are accepted. The system will automatically detect the order of the columns based on their headers.</p>
      </div>
      
      <div class="field">
        <label for="historicalFile">
          <i class="fas fa-upload"></i> Historical Data
        </label>
        <div class="file-upload">
          <input type="file" id="historicalFile" accept=".xlsx,.xls,.csv" onchange="previewData(this)">
          <div class="file-upload-label">
            <i class="fas fa-file-upload"></i>
            <span>Choose file or drag and drop</span>
          </div>
        </div>
        <div class="data-preview" id="dataPreview">
          <h4>Data Preview</h4>
          <div id="previewTable"></div>
        </div>
      </div>
      
      <div class="grid">
        <div class="field">
          <label for="timeUnit">
            <i class="fas fa-clock"></i> Time Unit
          </label>
          <div class="input-group">
            <i class="fas fa-calendar"></i>
            <select id="timeUnit">
              <option value="monthly">Monthly</option>
              <option value="weekly">Weekly</option>
              <option value="daily">Daily</option>
            </select>
          </div>
        </div>
        
        <div class="field">
          <label for="periodCount">
            <i class="fas fa-hashtag"></i> Forecast Periods
          </label>
          <div class="input-group">
            <i class="fas fa-chart-bar"></i>
            <input type="number" id="periodCount" min="1" max="120" placeholder="e.g. 12" value="12">
          </div>
        </div>
        
        <div class="field">
          <label for="dateFormat">
            <i class="fas fa-globe"></i> Date Format
          </label>
          <div class="input-group">
            <i class="fas fa-calendar-alt"></i>
            <select id="dateFormat">
              <option value="EUR">EUR (DD/MM/YYYY)</option>
              <option value="US">US (MM/DD/YYYY)</option>
            </select>
          </div>
        </div>
        
        <div class="field">
          <label for="decimalPlaces">
            <i class="fas fa-calculator"></i> Decimal(s)
          </label>
          <div class="input-group">
            <i class="fas fa-hashtag"></i>
            <select id="decimalPlaces">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
        </div>
        
        <div class="field">
          <label for="allowNegative">
            <i class="fas fa-shield-alt"></i> Allow Negative Forecast Values
          </label>
          <div class="input-group">
            <i class="fas fa-minus-circle"></i>
            <select id="allowNegative">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
        </div>
          <!-- Model Selection UI -->
          <div class="field">
            <label for="modelSelect">
              <i class="fas fa-cogs"></i> Forecast Model
            </label>
            <div class="input-group" style="position: relative;">
              <i class="fas fa-robot" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
              <select id="modelSelect" style="min-width: 180px; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border-radius: var(--radius-lg); border: 2px solid var(--border-color);">
                <option value="all" selected>All</option>
                <option value="arima">ARIMA</option>
                <option value="holtwinters">Holt-Winters</option>
                <option value="prophet">Prophet</option>
            </select>
          </div>
        </div>
      </div>
      
        <!-- Scenario Adjustment Section -->
        <div class="scenario-section" style="margin-top: 1rem; margin-bottom: 0;">
          <!-- Collapsible Header -->
          <div class="scenario-header" onclick="toggleScenarioPanel()" style="padding: 0.75rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); width: 100%;">
            <h3 style="margin: 0; color: var(--text-primary);">
              <i class="fas fa-sliders-h"></i> Scenario Adjustment
            </h3>
            <i class="fas fa-chevron-down" id="scenarioToggleIcon" style="color: var(--text-secondary); transition: transform 0.3s ease;"></i>
          </div>
          
          <!-- Collapsible Content -->
          <div class="scenario-content" id="scenarioContent" style="display: none; padding: 1.5rem; background: var(--card-bg); border: 2px solid var(--border-color); border-top: none; border-radius: 0 0 var(--radius-lg) var(--radius-lg); box-shadow: var(--shadow-sm); margin-top: -2px; width: 100%;">
            <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
              <i class="fas fa-info-circle"></i> Adjustments will be applied to all available forecast models (Holt-Winters, Prophet, ARIMA, and Average).
            </p>
            
            <!-- Row 1: Scenario Name -->
            <div class="scenario-inputs-row1" style="margin-bottom: 1rem;">
              <div class="field">
                <label for="scenarioName" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">
                  <i class="fas fa-tag"></i> Scenario Name
                </label>
                <div class="input-group" style="position: relative;">
                  <i class="fas fa-edit" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); z-index: 1;"></i>
                  <input type="text" id="scenarioName" placeholder="e.g. Marketing Campaign" style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: white; font-size: 0.9rem;">
                </div>
              </div>
            </div>
            
            <!-- Row 2: Select Items (Collapsible) -->
            <div class="scenario-inputs-row2" style="margin-bottom: 1rem;">
              <div class="field">
                <div class="items-header" onclick="toggleItemsPanel()" style="padding: 0.5rem 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: var(--radius-md); box-shadow: var(--shadow-sm);">
                  <label style="margin: 0; font-weight: 500; color: var(--text-primary);">
                    <i class="fas fa-boxes"></i> Select Items
                  </label>
                  <i class="fas fa-chevron-down" id="itemsToggleIcon" style="color: var(--text-secondary); transition: transform 0.3s ease;"></i>
                </div>
                <div class="items-content" id="itemsContent" style="display: none; padding: 1rem; background: white; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 var(--radius-md) var(--radius-md); box-shadow: var(--shadow-sm); margin-top: -1px;">
                  <div class="input-group" style="position: relative;">
                    <input type="text" id="scenarioItemsSearch" placeholder="Search items..." style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md) var(--radius-md) 0 0; background: white; font-size: 0.9rem; border-bottom: none;">
                    <div id="scenarioItemsContainer" style="width: 100%; border: 1px solid var(--border-color); border-radius: 0 0 var(--radius-md) var(--radius-md); background: white; max-height: 8rem; overflow-y: auto; padding: 0.5rem;">
                      <div style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; color: var(--primary-color);">
                          <input type="checkbox" id="selectAllItems" style="margin: 0;">
                          <span>Select All Items</span>
                        </label>
                      </div>
                      <div id="scenarioItemsList" style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <div style="text-align: center; color: var(--text-secondary); padding: 1rem;">Loading items...</div>
                      </div>
                    </div>
                  </div>
                  <small style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.5rem; display: block;">
                    <i class="fas fa-info-circle"></i> Leave empty to apply to all items
                  </small>
                </div>
              </div>
            </div>
            
            <!-- Row 3: Start Date, End Date, % Factor, Add Button (All on one line) -->
            <div class="scenario-inputs-row3" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
              <div class="field">
                <label for="startDate" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.85rem;">
                  <i class="fas fa-calendar"></i> Start Date
                </label>
                <div class="input-group" style="position: relative;">
                  <i class="fas fa-calendar-day" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); z-index: 1; font-size: 0.8rem;"></i>
                  <input type="date" id="startDate" style="width: 100%; padding: 0.6rem 0.6rem 0.6rem 2rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: white; font-size: 0.8rem;">
                </div>
              </div>
              
              <div class="field">
                <label for="endDate" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.85rem;">
                  <i class="fas fa-calendar"></i> End Date
                </label>
                <div class="input-group" style="position: relative;">
                  <i class="fas fa-calendar-day" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); z-index: 1; font-size: 0.8rem;"></i>
                  <input type="date" id="endDate" style="width: 100%; padding: 0.6rem 0.6rem 0.6rem 2rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: white; font-size: 0.8rem;">
                </div>
              </div>
              
              <div class="field">
                <label for="adjustmentFactor" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.85rem; white-space: nowrap;">
                  <i class="fas fa-percentage"></i> Factor
                </label>
                <div class="input-group" style="position: relative;">
                  <i class="fas fa-calculator" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); z-index: 1; font-size: 0.8rem;"></i>
                  <input type="number" id="adjustmentFactor" step="0.01" min="0.01" placeholder="e.g. 1.2" style="width: 100%; padding: 0.6rem 0.6rem 0.6rem 2rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: white; font-size: 0.8rem;">
                </div>
              </div>
              
              <button class="btn btn-secondary" onclick="addScenarioAdjustment()" style="height: fit-content; padding: 0.6rem 1rem; margin-top: 0.5rem; font-size: 0.8rem;">
                <i class="fas fa-plus"></i> Add
              </button>
            </div>
          
          <div class="scenario-table" id="scenarioTable" style="display: none;">
            <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
              <i class="fas fa-list"></i> Applied Adjustments
            </h4>
            <div class="table-container" style="background: white; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border-color);">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                <thead style="background: var(--bg-color);">
                  <tr>
                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; font-weight: 600;">Scenario</th>
                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; font-weight: 600;">Start Date</th>
                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; font-weight: 600;">End Date</th>
                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; font-weight: 600;">Factor</th>
                    <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; font-weight: 600;">Items</th>
                    <th style="padding: 0.5rem; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; font-weight: 600;">Action</th>
                  </tr>
                </thead>
                <tbody id="scenarioTableBody">
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="scenario-actions" style="margin-top: 1rem; display: flex; gap: 1rem;">
            <button class="btn btn-primary" onclick="applyScenario()" id="applyScenarioBtn" style="display: none;">
              <i class="fas fa-check"></i> Apply Scenario
            </button>
            <button class="btn btn-secondary" onclick="clearScenario()" id="clearScenarioBtn" style="display: none;">
              <i class="fas fa-trash"></i> Clear All
            </button>
          </div>
        </div>
      
      <button class="btn btn-primary" onclick="generateForecast()" id="generateBtn" style="margin-top: 2.5rem;">
        <i class="fas fa-rocket"></i>
        Generate Forecast
      </button>
      
      <button class="btn btn-back" onclick="showPage('homePage')">
        <i class="fas fa-arrow-left"></i>
        Back to Home
      </button>
      
      <!-- Forecast Preview Chart -->
      <div class="forecast-preview" id="forecastPreview">
        <h3><i class="fas fa-chart-line"></i> Forecast Preview</h3>
        <div class="chart-container">
          <canvas id="forecastChart"></canvas>
        </div>
        <div class="chart-summary" id="chartSummary">
          <h4>Summary</h4>
          <p id="summaryText"></p>
        </div>
        <div class="download-options" id="downloadOptions" style="display: none;">
          <h4><i class="fas fa-download"></i> Download Forecast</h4>
          <div class="download-buttons">
            <button class="btn btn-primary" onclick="downloadForecast('xlsx')">
              <i class="fas fa-file-excel"></i>
              Download Excel (.xlsx)
            </button>
            <button class="btn btn-secondary" onclick="downloadForecast('csv')">
              <i class="fas fa-file-csv"></i>
              Download CSV (.csv)
            </button>
          </div>
        </div>
      </div>
    </div>


  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="spinner" id="modalSpinner"></div>
      <p class="modal-text" id="modalText">Processing your request<span id="dots">.</span></p>
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Processing...</div>
      </div>
      <div class="modal-details" id="modalDetails" style="display: none;"></div>
      <div class="modal-buttons" id="modalButtons" style="display: none;">
        <button class="btn btn-back" onclick="hideModal()">
          <i class="fas fa-arrow-left"></i>
          Back
        </button>
      </div>
    </div>
  </div>

  <!-- Add after the main modal, before </body> -->
  <div class="modal" id="authModal">
    <div class="modal-content" style="max-width: 400px;">
      <a href="/" class="site-logo" style="position: static; margin-bottom: 1.5rem; display: flex; justify-content: center;">
        <img src="static/logo.png" alt="r4ise logo" style="width: 60px; height: 60px; border-radius: 16px; box-shadow: 0 2px 8px rgba(99,102,241,0.10); background: #fff; padding: 5px;" />
      </a>
      <h2 id="authTitle" style="margin-bottom: 1rem; color: var(--primary-color);">Sign In</h2>
      <form id="authForm">
        <div class="field">
          <label for="authEmail">Email</label>
          <input type="email" id="authEmail" required style="width: 100%; padding: 0.75rem; border-radius: var(--radius-lg); border: 2px solid var(--border-color);">
        </div>
        <div class="field">
          <label for="authPassword">Password</label>
          <input type="password" id="authPassword" required style="width: 100%; padding: 0.75rem; border-radius: var(--radius-lg); border: 2px solid var(--border-color);">
        </div>
        <div class="field" id="authError" style="color: var(--error-color); font-size: 0.95rem; display: none;"></div>
        <button type="submit" class="btn btn-primary" id="authSubmitBtn">Sign In</button>
        <button type="button" class="btn btn-secondary" id="toggleAuthMode" style="margin-top: 0.5rem;">Don't have an account? Register</button>
        
        <div style="margin-top: 1rem; text-align: center;">
          <div style="margin: 1rem 0; color: var(--text-secondary);">or</div>
          <button type="button" class="btn btn-secondary" id="googleSignInBtn" style="background: white; color: #333; border: 1px solid #ddd;">
            <span style="display: inline-block; width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="20" height="20">
                <g>
                  <path fill="#4285F4" d="M24 9.5c3.54 0 6.36 1.46 7.82 2.68l5.8-5.8C34.36 3.36 29.64 1 24 1 14.82 1 6.98 6.98 3.34 15.02l6.74 5.23C12.36 13.36 17.64 9.5 24 9.5z"/>
                  <path fill="#34A853" d="M46.1 24.5c0-1.64-.15-3.22-.43-4.74H24v9.02h12.42c-.54 2.92-2.18 5.39-4.66 7.06l7.18 5.59C43.98 37.02 46.1 31.23 46.1 24.5z"/>
                  <path fill="#FBBC05" d="M10.08 28.25c-1.08-3.23-1.08-6.77 0-10l-6.74-5.23C.98 13.98 0 18.82 0 24c0 5.18.98 10.02 3.34 13.98l6.74-5.23z"/>
                  <path fill="#EA4335" d="M24 46.5c5.64 0 10.36-1.86 13.82-5.09l-7.18-5.59c-2.02 1.36-4.6 2.18-7.64 2.18-6.36 0-11.64-3.86-13.92-9.25l-6.74-5.23C6.98 41.02 14.82 46.5 24 46.5z"/>
                  <path fill="none" d="M0 0h48v48H0z"/>
                </g>
              </svg>
            </span>
            Continue with Google
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pricing Plans Modal -->
    <!-- <div class="modal" id="pricingModal"> ... </div> -->

  <script>
    const modal = document.getElementById('modal');
    const dots = document.getElementById('dots');
    let dotInterval;

    function showPage(id) {
      document.querySelectorAll('.card').forEach(div => {
        div.classList.add('hidden');
        div.classList.remove('fade-in', 'slide-in');
      });
      const targetPage = document.getElementById(id);
      targetPage.classList.remove('hidden');
      targetPage.classList.add(id === 'homePage' ? 'fade-in' : 'slide-in');
      
      // Reset form states
      if (id === 'forecastPage') {
        resetForecastForm();
      }
    }

    function resetForecastForm() {
      document.getElementById('historicalFile').value = '';
      document.getElementById('periodCount').value = '12';
      document.getElementById('dateFormat').value = 'EUR';
      document.getElementById('decimalPlaces').value = '0';
      document.getElementById('allowNegative').value = 'false';
      document.getElementById('dataPreview').style.display = 'none';
      document.getElementById('forecastPreview').style.display = 'none';
      document.getElementById('downloadOptions').style.display = 'none';
      document.getElementById('generateBtn').disabled = false;
      updateFileLabel('historicalFile', 'Choose file or drag and drop');
      // Clear stored forecast settings
      window.forecastSettings = null;
    }



    function updateFileLabel(inputId, defaultText) {
      const input = document.getElementById(inputId);
      const label = input.parentElement.querySelector('.file-upload-label');
      label.classList.remove('success', 'error');
      label.innerHTML = `<i class="fas fa-file-upload"></i><span>${defaultText}</span>`;
    }

    function showModal(msg, details = null, showButtons = false, showProgress = false) {
      document.getElementById('modalText').textContent = msg;
      const detailsDiv = document.getElementById('modalDetails');
      const buttonsDiv = document.getElementById('modalButtons');
      const spinner = document.getElementById('modalSpinner');
      const progressContainer = document.getElementById('progressContainer');
      
      if (details) {
        detailsDiv.innerHTML = details;
        detailsDiv.style.display = 'block';
      } else {
        detailsDiv.style.display = 'none';
      }
      
      if (showButtons) {
        buttonsDiv.style.display = 'flex';
        spinner.style.display = 'none';
        progressContainer.style.display = 'none';
        clearInterval(dotInterval);
      } else if (showProgress) {
        buttonsDiv.style.display = 'none';
        spinner.style.display = 'none';
        progressContainer.style.display = 'block';
        simulateProgress();
      } else {
        buttonsDiv.style.display = 'none';
        progressContainer.style.display = 'none';
        spinner.style.display = 'block';
      let count = 1;
      dotInterval = setInterval(() => {
        dots.textContent = '.'.repeat(count);
        count = count === 3 ? 1 : count + 1;
      }, 500);
      }
      
      modal.style.display = 'flex';
    }

    function hideModal() {
      modal.style.display = 'none';
      clearInterval(dotInterval);
    }



    function simulateProgress() {
      const fill = document.getElementById('progressFill');
      const text = document.getElementById('progressText');
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        fill.style.width = progress + '%';
        text.textContent = `Processing... ${Math.round(progress)}%`;
        if (progress >= 90) {
          clearInterval(interval);
        }
      }, 500);
    }

    function previewData(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const wb = XLSX.read(e.target.result, { type: 'binary' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          
          if (data.length > 0) {
            const headers = data[0];
            const preview = data.slice(1, 6); // Show first 5 rows
            
            let tableHTML = '<table><thead><tr>';
            headers.forEach(header => {
              tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            preview.forEach(row => {
              tableHTML += '<tr>';
              row.forEach((cell, index) => {
                const header = headers[index] ? headers[index].toLowerCase() : '';
                let displayValue = cell === undefined || cell === null ? '' : cell;

                // Format quantity columns to 2 decimals
                if (header.includes('quantity') || header.includes('qty') || header.includes('amount')) {
                  displayValue = Number(cell).toFixed(2);
                }
                // Only try to convert to date if header is a date/time/period column
                else if (header.includes('date') || header.includes('time') || header.includes('period')) {
                  if (typeof cell === 'number' && cell > 1000) {
                    try {
                      const excelDate = new Date((cell - 25569) * 86400 * 1000);
                      if (!isNaN(excelDate.getTime())) {
                        displayValue = excelDate.toLocaleDateString('en-US', {
                          year: 'numeric',
                          month: 'short'
                        });
                      }
                    } catch (dateError) {
                      // If date conversion fails, keep original value
                      console.log('Date conversion failed for:', cell);
                    }
                  }
                }
                // For item id and all other columns, just display as string

                tableHTML += `<td>${displayValue}</td>`;
              });
              tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            
            document.getElementById('previewTable').innerHTML = tableHTML;
            document.getElementById('dataPreview').style.display = 'block';
            
            // Smooth scroll to show the uploaded file name at the top of the page
            setTimeout(() => {
              const historicalDataLabel = document.querySelector('label[for="historicalFile"]');
              if (historicalDataLabel) {
                const offset = 20;
                const elementPosition = historicalDataLabel.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                const startPosition = window.pageYOffset;
                const distance = offsetPosition - startPosition;
                const duration = 1200;
                
                let start = null;
                function animation(currentTime) {
                  if (start === null) start = currentTime;
                  const timeElapsed = currentTime - start;
                  const run = easeInOutCubic(timeElapsed, startPosition, distance, duration);
                  window.scrollTo(0, run);
                  if (timeElapsed < duration) requestAnimationFrame(animation);
                }
                function easeInOutCubic(t, b, c, d) {
                  t /= d / 2;
                  if (t < 1) return c / 2 * t * t * t + b;
                  t -= 2;
                  return c / 2 * (t * t * t + 2) + b;
                }
                requestAnimationFrame(animation);
              }
            }, 500);
            
            // Extract and populate distinct Item IDs for scenario dropdown
            populateItemDropdown(data, headers);
          }
        } catch (error) {
          console.error('Error previewing data:', error);
        }
      };
      reader.readAsBinaryString(file);
    }
    
    // Populate Item ID dropdown for scenario adjustments
    function populateItemDropdown(data, headers) {
      try {
        // Find the Item ID column index
        const itemIdIndex = headers.findIndex(header => 
          header && header.toLowerCase().includes('item') && header.toLowerCase().includes('id')
        );
        
        if (itemIdIndex === -1) {
          console.warn('Item ID column not found in headers:', headers);
          return;
        }
        
        // Extract distinct Item IDs from the data (skip header row)
        const itemIds = [...new Set(data.slice(1).map(row => row[itemIdIndex]).filter(id => id && id.toString().trim() !== ''))];
        
        // Sort Item IDs for better UX
        itemIds.sort();
        
        // Store item IDs globally for access by other functions
        window.availableItemIds = itemIds;
        
        // Populate the checkbox list
        const itemsList = document.getElementById('scenarioItemsList');
        itemsList.innerHTML = '';
        
        // Add Item ID checkboxes
        itemIds.forEach(itemId => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'item-checkbox';
          itemDiv.style.padding = '0.25rem 0.5rem';
          itemDiv.style.borderRadius = 'var(--radius-sm)';
          itemDiv.style.transition = 'background-color 0.2s';
          
          const label = document.createElement('label');
          label.style.display = 'flex';
          label.style.alignItems = 'center';
          label.style.gap = '0.5rem';
          label.style.cursor = 'pointer';
          label.style.fontSize = '0.9rem';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = itemId;
          checkbox.className = 'item-checkbox-input';
          checkbox.style.margin = '0';
          
          const span = document.createElement('span');
          span.textContent = itemId;
          
          label.appendChild(checkbox);
          label.appendChild(span);
          itemDiv.appendChild(label);
          itemsList.appendChild(itemDiv);
        });
        
        console.log(`Populated scenario dropdown with ${itemIds.length} distinct Item IDs`);
        
        // Add search functionality
        const searchInput = document.getElementById('scenarioItemsSearch');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const itemDivs = itemsList.querySelectorAll('.item-checkbox');
            
            itemDivs.forEach(itemDiv => {
              const text = itemDiv.textContent.toLowerCase();
              if (text.includes(searchTerm)) {
                itemDiv.style.display = '';
                itemDiv.style.backgroundColor = '';
              } else {
                itemDiv.style.display = 'none';
              }
            });
          });
        }
        
        // Add select all functionality
        const selectAllCheckbox = document.getElementById('selectAllItems');
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener('change', function() {
            const itemCheckboxes = itemsList.querySelectorAll('.item-checkbox-input');
            itemCheckboxes.forEach(checkbox => {
              checkbox.checked = this.checked;
            });
          });
        }
        
        // Update select all when individual checkboxes change
        itemsList.addEventListener('change', function(e) {
          if (e.target.classList.contains('item-checkbox-input')) {
            const itemCheckboxes = itemsList.querySelectorAll('.item-checkbox-input');
            const selectAllCheckbox = document.getElementById('selectAllItems');
            const checkedCount = itemsList.querySelectorAll('.item-checkbox-input:checked').length;
            
            if (checkedCount === 0) {
              selectAllCheckbox.checked = false;
              selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === itemCheckboxes.length) {
              selectAllCheckbox.checked = true;
              selectAllCheckbox.indeterminate = false;
            } else {
              selectAllCheckbox.checked = false;
              selectAllCheckbox.indeterminate = true;
            }
          }
        });
        
      } catch (error) {
        console.error('Error populating Item ID dropdown:', error);
      }
    }

    function readFileAsCSV(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const csv = XLSX.utils.sheet_to_csv(sheet, { FS: ',', RS: '\n', strip: true });
            resolve(csv);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = e => reject(e);
        reader.readAsBinaryString(file);
      });
    }

          // Scenario Adjustment Functions
    let scenarioAdjustments = [];
    
    // Toggle scenario panel visibility
    function toggleScenarioPanel() {
      const content = document.getElementById('scenarioContent');
      const icon = document.getElementById('scenarioToggleIcon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }
    
    // Toggle items panel visibility
    function toggleItemsPanel() {
      const content = document.getElementById('itemsContent');
      const icon = document.getElementById('itemsToggleIcon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }
    
    // Update forecast periods limit based on time unit
    function updateForecastPeriodsLimit() {
      const timeUnit = document.getElementById('timeUnit').value;
      const periodInput = document.getElementById('periodCount');
      
      let maxPeriods;
      switch (timeUnit) {
        case 'monthly':
          maxPeriods = 36;
          break;
        case 'weekly':
          maxPeriods = 156;
          break;
        case 'daily':
          maxPeriods = 1096;
          break;
        default:
          maxPeriods = 36;
      }
      
      periodInput.max = maxPeriods;
      
      // If current value exceeds new max, reset to max
      if (parseInt(periodInput.value) > maxPeriods) {
        periodInput.value = maxPeriods;
      }
      
      // Update placeholder to show the new limit
      periodInput.placeholder = `e.g. 12 (max: ${maxPeriods})`;
    }
      
      function addScenarioAdjustment() {
        const name = document.getElementById('scenarioName').value.trim();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const factor = parseFloat(document.getElementById('adjustmentFactor').value);
        
        // Get selected items from checkboxes
        const selectedItemCheckboxes = document.querySelectorAll('.item-checkbox-input:checked');
        const selectedItems = Array.from(selectedItemCheckboxes).map(checkbox => checkbox.value);
        
        // Validation
        if (!name) {
          showError('Please enter a scenario name');
          return;
        }
        if (!startDate || !endDate) {
          showError('Please select both start and end dates');
          return;
        }
        if (startDate >= endDate) {
          showError('End date must be after start date');
          return;
        }
        if (!factor || factor <= 0) {
          showError('Please enter a valid adjustment factor (greater than 0)');
          return;
        }
      
        // Add to adjustments array
        const adjustment = {
          name: name,
          start: startDate,
          end: endDate,
          factor: factor,
          items: selectedItems // Include selected items
        };
        scenarioAdjustments.push(adjustment);
        
        // Update table
        updateScenarioTable();
        
        // Clear inputs
        document.getElementById('scenarioName').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('adjustmentFactor').value = '';
        
        // Clear selected items
        const allItemCheckboxes = document.querySelectorAll('.item-checkbox-input');
        allItemCheckboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
        
        // Reset select all checkbox
        const selectAllCheckbox = document.getElementById('selectAllItems');
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
        
        // Clear search
        const searchInput = document.getElementById('scenarioItemsSearch');
        if (searchInput) {
          searchInput.value = '';
          // Trigger search to show all items
          searchInput.dispatchEvent(new Event('input'));
        }
        
        // Show success message
        showSuccess(`Added scenario: ${name} (${factor}x from ${startDate} to ${endDate})`);
      }
      
      function removeScenarioAdjustment(index) {
        const removed = scenarioAdjustments.splice(index, 1)[0];
        updateScenarioTable();
        showSuccess(`Removed scenario: ${removed.name}`);
      }
      
      function updateScenarioTable() {
        const tableBody = document.getElementById('scenarioTableBody');
        const table = document.getElementById('scenarioTable');
        const applyBtn = document.getElementById('applyScenarioBtn');
        const clearBtn = document.getElementById('clearScenarioBtn');
        
        if (scenarioAdjustments.length === 0) {
          table.style.display = 'none';
          applyBtn.style.display = 'none';
          clearBtn.style.display = 'none';
        return;
      }
        
        table.style.display = 'block';
        applyBtn.style.display = 'inline-flex';
        clearBtn.style.display = 'inline-flex';
        
        tableBody.innerHTML = '';
        scenarioAdjustments.forEach((adjustment, index) => {
          const row = document.createElement('tr');
          const itemsText = adjustment.items && adjustment.items.length > 0 
            ? adjustment.items.join(', ') 
            : 'All Items';
          row.innerHTML = `
            <td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.75rem;">${adjustment.name}</td>
            <td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.75rem;">${adjustment.start}</td>
            <td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.75rem;">${adjustment.end}</td>
            <td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.75rem;">${adjustment.factor}x</td>
            <td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.75rem;">${itemsText}</td>
            <td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); text-align: center; font-size: 0.75rem;">
              <button onclick="removeScenarioAdjustment(${index})" style="background: var(--error-color); color: white; border: none; border-radius: var(--radius-sm); padding: 0.2rem 0.4rem; cursor: pointer; font-size: 0.7rem;">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }
      
      async function applyScenario() {
        console.log('applyScenario called');
        console.log('scenarioAdjustments:', scenarioAdjustments);
        
        if (scenarioAdjustments.length === 0) {
          showError('No scenario adjustments to apply');
          return;
        }
        
        // Create scenario JSON structure
        const scenario = {
          type: "multiplier",
          name: scenarioAdjustments[0].name, // Use first scenario name as overall name
          target: "all", // Apply to all models
          adjustments: scenarioAdjustments.map(adj => ({
            start: adj.start,
            end: adj.end,
            factor: adj.factor,
            items: adj.items || [] // Include selected items for each adjustment
          }))
        };
        
        console.log('Created scenario object:', scenario);
        
        // Store scenario for use in forecast generation
        window.currentScenario = scenario;
        console.log('Stored scenario in window.currentScenario:', window.currentScenario);
        
        showSuccess(`Scenario applied: ${scenario.name} with ${scenario.adjustments.length} adjustment(s)`);
        
        // Test the debug endpoint
        try {
          const debugResponse = await fetch('/api/debug/scenario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ scenario: scenario })
          });
          const debugResult = await debugResponse.json();
          console.log('Debug endpoint result:', debugResult);
        } catch (e) {
          console.error('Debug endpoint error:', e);
        }
      }
      
      function clearScenario() {
        scenarioAdjustments = [];
        window.currentScenario = null;
        updateScenarioTable();
        showSuccess('All scenario adjustments cleared');
      }

      async function generateForecast() {
        // const token = localStorage.getItem('auth_token');
        // const userEmail = localStorage.getItem('user_email');
        
        // If not authenticated, show payment options
        // if (!token || !userEmail) {
        //   showPricingModal();
        //   return;
        // }
        
        // Check if user has access to generate forecasts
        // const userAccess = await checkUserAccess();
        // if (!userAccess || !userAccess.access.is_active) {
        //   showPricingModal();
        //   return;
        // }
      
      // Proceed with forecast generation
      const file = document.getElementById('historicalFile').files[0];
      const timeUnit = document.getElementById('timeUnit').value;
      const periods = document.getElementById('periodCount').value.trim();
      const dateFormat = document.getElementById('dateFormat').value;
      const decimalPlaces = document.getElementById('decimalPlaces').value;
      const allowNegative = document.getElementById('allowNegative').value === 'true';

      if (!file) {
        showError('Please upload a historical data file');
        return;
      }

      if (!periods || periods < 1 || periods > 120) {
        showError('Please specify a valid number of periods (1-120)');
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      generateBtn.disabled = true;
      showModal("Analyzing your data and generating forecasts...", null, false, true);

      try {
        const csv = await readFileAsCSV(file);
        console.log('Sending forecast request...');
        
        // Store current settings for later download
        window.forecastSettings = {
          csv,
          timeUnit,
          periods,
          dateFormat,
          decimalPlaces: parseInt(decimalPlaces),
          allowNegative: allowNegative
        };
        
          // Model selection flags
          const modelSelect = document.getElementById('modelSelect');
          let useARIMA = false, useHW = false, useProphet = false;
          const selectedModel = modelSelect.value;
          if (selectedModel === 'all') {
            useARIMA = useHW = useProphet = true;
          } else if (selectedModel === 'arima') {
            useARIMA = true;
          } else if (selectedModel === 'holtwinters') {
            useHW = true;
          } else if (selectedModel === 'prophet') {
            useProphet = true;
          }
          
          // Prepare request body with scenario data if available
          const requestBody = { 
            csv, 
            timeUnit, 
            periods, 
            exportFormat: 'csv',
            dateFormat: dateFormat,
            decimalPlaces: parseInt(decimalPlaces),
            allowNegative: allowNegative,
            useARIMA,
            useHW,
            useProphet
          };
          
          // Add scenario data if available
          console.log('Checking for scenario data...');
          console.log('window.currentScenario:', window.currentScenario);
          console.log('scenarioAdjustments:', scenarioAdjustments);
          
          if (window.currentScenario) {
            requestBody.scenario = window.currentScenario;
            console.log('Including scenario in request:', window.currentScenario);
          } else {
            console.log('No scenario data available');
          }
          
          const res = await fetch('/api/forecast', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });
        
        console.log('Response status:', res.status);
        console.log('Response headers:', Object.fromEntries(res.headers.entries()));
        
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || "Forecast generation failed");
        }
        
        // Handle response for preview
        const contentType = res.headers.get('content-type');
        console.log('Content-Type:', contentType);
        const blob = await res.blob();
        console.log('Blob size:', blob.size);
        
        // Parse and show preview
        await parseForecastAndCreateChart(blob, 'csv');
        showSuccess('Forecast generated successfully! Preview is now available.');
        
      } catch (e) {
        console.error('Forecast error:', e);
        showError('Error: ' + e.message);
      } finally {
        generateBtn.disabled = false;
        hideModal();
      }
    }



    function showError(message) {
      showModal('Error', `<div style="color: var(--error-color); font-weight: 600;">${message}</div>`, true);
    }

    function showSuccess(message) {
      showModal('Success', `<div style="color: var(--secondary-color); font-weight: 600;">${message}</div>`);
      setTimeout(hideModal, 2000);
    }

    function downloadCSV(text, filename) {
      const blob = new Blob([text], { type: 'text/csv' });
      downloadBlob(blob, filename);
    }

    function downloadBlob(blob, filename) {
      console.log('Starting download for:', filename);
      console.log('Blob type:', blob.type);
      console.log('Blob size:', blob.size);
      
      // Single download method to prevent duplicate popups
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.style.display = 'none';
      
      // Add to DOM and trigger
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Cleanup
      setTimeout(() => {
        URL.revokeObjectURL(url);
      }, 2000);
      
      console.log('Download triggered for:', filename);
    }
    
    // Parse forecast data and create chart
    async function parseForecastAndCreateChart(blob, outputFormat) {
      try {
        let forecastData = [];
          let bestModel = null;
          let bestModelCol = null;
          let header = [];
        if (outputFormat === 'xlsx') {
          // Parse Excel file
          const arrayBuffer = await blob.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          forecastData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        } else {
          // Parse CSV file
          const text = await blob.text();
          const lines = text.split('\n');
          forecastData = lines.map(line => line.split(',').map(cell => cell.trim()));
        }
          if (forecastData.length < 2) return;
          header = forecastData[0];
          // --- Custom logic: Use TOTAL Prophet row if present ---
          const itemIdIdx = header.indexOf('Item ID');
          const dateIdx = header.indexOf('Date');
          const prophetIdx = header.indexOf('Forecast (Prophet)');
          let totalRows = [];
          if (itemIdIdx !== -1 && prophetIdx !== -1) {
            totalRows = forecastData.slice(1).filter(row => row[itemIdIdx] && row[itemIdIdx].toUpperCase() === 'TOTAL');
          }
          if (totalRows.length > 0) {
            // Use TOTAL Prophet row for preview
            const dates = totalRows.map(row => row[dateIdx]);
            const quantities = totalRows.map(row => parseFloat(row[prophetIdx]) || 0);
            createForecastChart(dates, quantities);
            showForecastSummary(Object.fromEntries(dates.map((d, i) => [d, quantities[i]])));
            document.getElementById('forecastPreview').style.display = 'block';
            document.getElementById('downloadOptions').style.display = 'block';
            setTimeout(() => {
              const previewElement = document.getElementById('forecastPreview');
              const offset = 80;
              const elementPosition = previewElement.getBoundingClientRect().top;
              const offsetPosition = elementPosition + window.pageYOffset - offset;
              const startPosition = window.pageYOffset;
              const distance = offsetPosition - startPosition;
              const duration = 1200;
              let start = null;
              function animation(currentTime) {
                if (start === null) start = currentTime;
                const timeElapsed = currentTime - start;
                const run = easeInOutCubic(timeElapsed, startPosition, distance, duration);
                window.scrollTo(0, run);
                if (timeElapsed < duration) requestAnimationFrame(animation);
              }
              function easeInOutCubic(t, b, c, d) {
                t /= d / 2;
                if (t < 1) return c / 2 * t * t * t + b;
                t -= 2;
                return c / 2 * (t * t * t + 2) + b;
              }
              requestAnimationFrame(animation);
            }, 500);
            return;
          }
          // --- End custom logic ---
          // Existing logic fallback
          // Find best model from the first row (assume all rows have the same best model)
          const bestModelIdx = header.indexOf('Best Model');
          if (bestModelIdx !== -1) {
            bestModel = forecastData[1][bestModelIdx];
          }
          // Determine which forecast column to use
          if (bestModel) {
            bestModelCol = header.find(h => h.toLowerCase().includes(bestModel.toLowerCase()));
          }
          // Fallback order if not found
          if (!bestModelCol) {
            bestModelCol = header.find(h => h.toLowerCase().includes('prophet')) || header.find(h => h.toLowerCase().includes('holt')) || header.find(h => h.toLowerCase().includes('arima'));
          }
          const forecastIdx = header.indexOf(bestModelCol);
          // Remove header row and empty rows
          const rows = forecastData.slice(1).filter(row => row.length >= 3 && row[0] !== 'Date');
          
          // AGGREGATE DATA BY DATE: Sum quantities across all items for each date
          const dateAggregation = {};
          rows.forEach(row => {
            const date = row[dateIdx];
            const quantity = parseFloat(row[forecastIdx]) || 0;
            if (date) {
              if (!dateAggregation[date]) {
                dateAggregation[date] = 0;
              }
              dateAggregation[date] += quantity;
            }
          });
          
          // Sort dates and build arrays for chart
          const sortedDates = Object.keys(dateAggregation).sort();
          const dates = sortedDates;
          let quantities = sortedDates.map(date => dateAggregation[date]);
          
          // Note: Scenario adjustments are now handled by the backend
          // The downloaded file should already contain the adjusted values
          // No need to apply adjustments here as it would cause double application
        createForecastChart(dates, quantities);
          showForecastSummary(Object.fromEntries(dates.map((d, i) => [d, quantities[i]])));
        document.getElementById('forecastPreview').style.display = 'block';
        document.getElementById('downloadOptions').style.display = 'block';
        setTimeout(() => {
          const previewElement = document.getElementById('forecastPreview');
            const offset = 80;
          const elementPosition = previewElement.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - offset;
          const startPosition = window.pageYOffset;
          const distance = offsetPosition - startPosition;
            const duration = 1200;
          let start = null;
          function animation(currentTime) {
            if (start === null) start = currentTime;
            const timeElapsed = currentTime - start;
            const run = easeInOutCubic(timeElapsed, startPosition, distance, duration);
            window.scrollTo(0, run);
            if (timeElapsed < duration) requestAnimationFrame(animation);
          }
          function easeInOutCubic(t, b, c, d) {
            t /= d / 2;
            if (t < 1) return c / 2 * t * t * t + b;
            t -= 2;
            return c / 2 * (t * t * t + 2) + b;
          }
          requestAnimationFrame(animation);
        }, 500);
      } catch (error) {
        console.error('Error parsing forecast data:', error);
      }
    }
    
    function createForecastChart(dates, quantities) {
      const ctx = document.getElementById('forecastChart').getContext('2d');
      // Destroy existing chart if it exists and is a Chart.js instance
      if (window.forecastChart && typeof window.forecastChart.destroy === 'function') {
        window.forecastChart.destroy();
      }
      window.forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
              label: 'Total Forecast Quantity',
            data: quantities,
            borderColor: 'rgb(99, 102, 241)',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: 'rgb(99, 102, 241)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgb(99, 102, 241)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return 'Date: ' + context[0].label;
                },
                label: function(context) {
                  return 'Forecast: ' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Time Period',
                color: 'var(--text-secondary)',
                font: {
                  size: 12,
                  weight: '500'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: 'var(--text-secondary)',
                maxTicksLimit: 8
              }
            },
            y: {
              title: {
                display: true,
                  text: 'Total Forecast Quantity',
                color: 'var(--text-secondary)',
                font: {
                  size: 12,
                  weight: '500'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: 'var(--text-secondary)',
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }
    
    function showForecastSummary(aggregatedData) {
      const quantities = Object.values(aggregatedData);
      const total = quantities.reduce((sum, qty) => sum + qty, 0);
      const average = total / quantities.length;
      const min = Math.min(...quantities);
      const max = Math.max(...quantities);
      const periods = quantities.length;
      
      const summaryText = `
        <strong>Total Forecast:</strong> ${total.toLocaleString()} units<br>
        <strong>Average per Period:</strong> ${average.toLocaleString(undefined, {maximumFractionDigits: 0})} units<br>
        <strong>Range:</strong> ${min.toLocaleString()} - ${max.toLocaleString()} units<br>
        <strong>Forecast Periods:</strong> ${periods} periods
      `;
      
      document.getElementById('summaryText').innerHTML = summaryText;
    }

    async function downloadForecast(format) {
      if (!window.forecastSettings) {
        showError('No forecast data available. Please generate a forecast first.');
        return;
      }

      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.disabled = true;
      downloadBtn.innerHTML = '<i class="fas fa-spinner spinning"></i> Generating...';

      try {
        // Prepare request body with scenario data if available
        const requestBody = { 
          ...window.forecastSettings,
          exportFormat: format
        };
        
        // Add scenario data if available
        if (window.currentScenario) {
          requestBody.scenario = window.currentScenario;
          console.log('Including scenario in download request:', window.currentScenario);
        }
        
        const res = await fetch('/api/forecast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || "Download generation failed");
        }
        
        const blob = await res.blob();
        const filename = format === 'xlsx' ? 'AI_generated_Forecast.xlsx' : 'AI_generated_Forecast.csv';
        
        downloadBlob(blob, filename);
        showSuccess(`${format.toUpperCase()} forecast downloaded successfully!`);
        
      } catch (e) {
        console.error('Download error:', e);
        showError('Error: ' + e.message);
      } finally {
        downloadBtn.disabled = false;
        downloadBtn.innerHTML = originalText;
      }
    }

    function downloadXLSX(csvText, filename) {
      const rows = csvText.split('\n').map(r => r.split(',').map(c => c.trim()));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Forecast');
      XLSX.writeFile(wb, filename);
    }

    // File upload visual feedback
    document.querySelectorAll('input[type="file"]').forEach(input => {
      input.addEventListener('change', function() {
        const label = this.parentElement.querySelector('.file-upload-label');
        if (this.files.length > 0) {
          label.classList.add('success');
          label.innerHTML = `<i class="fas fa-check"></i><span>${this.files[0].name}</span>`;
        } else {
          label.classList.remove('success');
          const defaultText = this.id === 'historicalFile' ? 'Choose file or drag and drop' : 'Choose file or drag and drop';
          label.innerHTML = `<i class="fas fa-file-upload"></i><span>${defaultText}</span>`;
        }
      });
    });

    // Drag and drop functionality
    document.querySelectorAll('.file-upload-label').forEach(label => {
      label.addEventListener('dragover', (e) => {
        e.preventDefault();
        label.style.borderColor = 'var(--primary-color)';
        label.style.background = 'rgb(99 102 241 / 0.1)';
      });

      label.addEventListener('dragleave', (e) => {
        e.preventDefault();
        label.style.borderColor = 'var(--border-color)';
        label.style.background = 'var(--bg-color)';
      });

      label.addEventListener('drop', (e) => {
        e.preventDefault();
        label.style.borderColor = 'var(--border-color)';
        label.style.background = 'var(--bg-color)';
        
        const input = label.parentElement.querySelector('input[type="file"]');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          input.files = files;
          input.dispatchEvent(new Event('change'));
        }
      });
    });

    // Supabase config
    const SUPABASE_URL = 'https://iayecqndmobjswtzoldb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlheWVjcW5kbW9ianN3dHpvbGRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjU1MjUsImV4cCI6MjA2NzgwMTUyNX0.FpndmbB-t9dvJsUFUX8l4VdLlbP4BZ1a425116UF10Q';
    
    console.log('Supabase URL:', SUPABASE_URL);
    console.log('Current location:', window.location.href);
    
    let supabase;
    
    // Initialize Supabase client with retry logic
    function initializeSupabase() {
      try {
        if (window.supabase) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('Supabase client initialized successfully');
          return true;
        } else {
          console.log('Supabase library not loaded yet, retrying...');
          return false;
        }
      } catch (error) {
        console.error('Failed to initialize Supabase client:', error);
        return false;
      }
    }
    
    // Try to initialize immediately
    if (!initializeSupabase()) {
      // If not ready, wait for DOM content loaded
      window.addEventListener('DOMContentLoaded', () => {
        if (!initializeSupabase()) {
          console.error('Failed to initialize Supabase after DOM load');
        }
      });
    }

    // Auth modal logic
    const authModal = document.getElementById('authModal');
    const authForm = document.getElementById('authForm');
    const authTitle = document.getElementById('authTitle');
    const authError = document.getElementById('authError');
    const authSubmitBtn = document.getElementById('authSubmitBtn');
    const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
    const googleSignInBtn = document.getElementById('googleSignInBtn');
    let isSignIn = true;

    function showAuthModal(mode = 'signin') {
      authModal.style.display = 'flex';
      authError.style.display = 'none';
      authForm.reset();
      
      // Set the mode based on parameter
      isSignIn = mode === 'signin';
      
      authTitle.textContent = isSignIn ? 'Sign In' : 'Register';
      authSubmitBtn.textContent = isSignIn ? 'Sign In' : 'Register';
      toggleAuthModeBtn.textContent = isSignIn ? "Don't have an account? Register" : 'Already have an account? Sign In';
    }
    
    function toggleAuthModal(mode = 'signin') {
      showAuthModal(mode);
    }
    
    function hideAuthModal() {
      authModal.style.display = 'none';
    }
    toggleAuthModeBtn.onclick = function() {
      isSignIn = !isSignIn;
      showAuthModal();
    };
    authForm.onsubmit = async function(e) {
      e.preventDefault();
      authError.style.display = 'none';
      authSubmitBtn.disabled = true;
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      try {
        // Use Flask backend authentication instead of Supabase client
        const endpoint = isSignIn ? '/api/auth/signin' : '/api/auth/signup';
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, password })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Authentication failed');
        }
        
        // Store the token locally
        if (result.token) {
          localStorage.setItem('auth_token', result.token);
          localStorage.setItem('user_email', result.user.email);
        }
        
        hideAuthModal();
        onAuthStateChanged();
        
        // If we were on the forecast page, stay there and show subscription status
        if (document.getElementById('forecastPage').classList.contains('hidden') === false) {
          setTimeout(updateSubscriptionUI, 100);
        }
      } catch (err) {
        authError.textContent = err.message;
        authError.style.display = 'block';
      } finally {
        authSubmitBtn.disabled = false;
      }
    };

    // Google Sign-in functionality
    googleSignInBtn.onclick = async function() {
      try {
        authError.style.display = 'none';
        googleSignInBtn.disabled = true;
        googleSignInBtn.innerHTML = '<i class="fas fa-spinner spinning"></i> Signing in...';
        
        console.log('Starting Google OAuth flow...');
        
        // Use redirect-based OAuth with explicit redirectTo
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin + '/',
            queryParams: {
              access_type: 'offline',
              prompt: 'consent'
            }
          }
        });
        
        if (error) throw error;
        
        console.log('Google sign-in initiated:', data);
        console.log('OAuth URL:', data?.url);
        
        // If we get a URL, redirect to it
        if (data?.url) {
          console.log('OAuth URL received:', data.url);
          console.log('About to redirect to:', data.url);
          
          // Check if the URL contains localhost
          if (data.url.includes('localhost')) {
            console.error('ERROR: OAuth URL contains localhost!');
            console.error('This means Google Cloud Console still has localhost redirect URIs');
            throw new Error('OAuth configuration error: URL contains localhost');
          }
          
          console.log('Redirecting to OAuth URL...');
          window.location.href = data.url;
        } else {
          throw new Error('No OAuth URL received');
        }
        
      } catch (err) {
        console.error('Google sign-in error:', err);
        authError.textContent = err.message || 'Google sign-in failed';
        authError.style.display = 'block';
        googleSignInBtn.disabled = false;
        googleSignInBtn.innerHTML = '<i class="fab fa-google" style="color: #4285f4; margin-right: 0.5rem;"></i>Continue with Google';
      }
    };


    // Show login modal if not logged in
    async function onAuthStateChanged() {
      try {
        console.log('=== AUTH STATE CHECK START ===');
        
        // Check for OAuth completion in URL
        const urlParams = new URLSearchParams(window.location.search);
        const hasOAuthParams = urlParams.has('access_token') || urlParams.has('refresh_token') || urlParams.has('provider_token');
        console.log('OAuth URL params detected:', hasOAuthParams);
        
        // Check for local authentication token
        const token = localStorage.getItem('auth_token');
        const userEmail = localStorage.getItem('user_email');
        
        console.log('Local Token:', token ? 'Present' : 'Missing');
        console.log('Local User Email:', userEmail || 'Missing');
        
        // Check for Supabase authentication (Google OAuth)
        let supabaseUser = null;
        let supabaseSession = null;
        
        if (supabase) {
          try {
            console.log('Checking Supabase auth...');
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError) {
              console.log('Supabase getUser error:', userError);
            } else {
              supabaseUser = user;
              console.log('Supabase User:', supabaseUser ? `Present (${supabaseUser.email})` : 'Missing');
            }
            
            // Also check for session
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError) {
              console.log('Supabase getSession error:', sessionError);
            } else {
              supabaseSession = session;
              console.log('Supabase Session:', supabaseSession ? 'Present' : 'Missing');
            }
            
            // If we have OAuth params but no session, try to get session from URL
            if (hasOAuthParams && !supabaseSession) {
              console.log('OAuth params detected, trying to get session from URL...');
              const { data: { session: urlSession }, error: urlError } = await supabase.auth.getSession();
              if (urlSession) {
                supabaseSession = urlSession;
                supabaseUser = urlSession.user;
                console.log('Session retrieved from URL:', urlSession.user?.email);
              }
            }
          } catch (e) {
            console.log('Supabase auth check failed:', e);
          }
        } else {
          console.log('Supabase client not initialized');
        }
        
        const authButtons = document.getElementById('authButtons');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        
        console.log('UI Elements - authButtons:', !!authButtons, 'userInfo:', !!userInfo, 'userName:', !!userName);
        
        // Check if user is authenticated (either local or Supabase)
        const isAuthenticated = (token && userEmail) || supabaseUser || supabaseSession;
        
        console.log('Is Authenticated:', isAuthenticated);
        
        if (!isAuthenticated) {
          console.log('No auth found, showing auth buttons');
          if (authButtons) authButtons.style.display = 'flex';
          if (userInfo) userInfo.style.display = 'none';
          // Only redirect to home if we're not already on a page
          if (document.getElementById('forecastPage').classList.contains('hidden') && 
              document.getElementById('homePage').classList.contains('hidden')) {
            document.getElementById('forecastPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
          }
        } else {
          console.log('Auth found, showing user info');
          if (authButtons) authButtons.style.display = 'none';
          if (userInfo) userInfo.style.display = 'flex';
          
          // Use Supabase user email if available, otherwise use local
          const displayEmail = supabaseUser ? supabaseUser.email : userEmail;
          console.log('Display Email:', displayEmail);
          if (userName) userName.textContent = displayEmail;
          
          hideAuthModal();
          // Update subscription UI if on forecast page
          if (document.getElementById('forecastPage').classList.contains('hidden') === false) {
            setTimeout(updateSubscriptionUI, 100);
          }
        }
        
        console.log('=== AUTH STATE CHECK END ===');
      } catch (err) {
        console.error('Auth state check error:', err);
        const authButtons = document.getElementById('authButtons');
        const userInfo = document.getElementById('userInfo');
        if (authButtons) authButtons.style.display = 'flex';
        if (userInfo) userInfo.style.display = 'none';
      }
    }
    
    // Debug function - can be called from browser console
    window.debugAuth = async function() {
      console.log('=== MANUAL AUTH DEBUG ===');
      console.log('Local Storage:');
      console.log('  auth_token:', localStorage.getItem('auth_token') ? 'Present' : 'Missing');
      console.log('  user_email:', localStorage.getItem('user_email') || 'Missing');
      
      try {
        console.log('Supabase Auth:');
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        console.log('  User:', user ? `Present (${user.email})` : 'Missing');
        console.log('  User Error:', userError || 'None');
        
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        console.log('  Session:', session ? 'Present' : 'Missing');
        console.log('  Session Error:', sessionError || 'None');
      } catch (e) {
        console.log('  Supabase Error:', e);
      }
      
      console.log('UI State:');
      const authButtons = document.getElementById('authButtons');
      const userInfo = document.getElementById('userInfo');
      console.log('  authButtons display:', authButtons ? authButtons.style.display : 'Element not found');
      console.log('  userInfo display:', userInfo ? userInfo.style.display : 'Element not found');
      console.log('=== END DEBUG ===');
    };
    
    // Force refresh auth state - can be called from browser console
    window.refreshAuth = async function() {
      console.log('=== FORCE REFRESH AUTH ===');
      try {
        // Try to refresh the session
        const { data, error } = await supabase.auth.refreshSession();
        console.log('Session refresh result:', data ? 'Success' : 'Failed');
        console.log('Session refresh error:', error || 'None');
        
        // Check auth state again
        onAuthStateChanged();
      } catch (e) {
        console.log('Session refresh failed:', e);
        onAuthStateChanged();
      }
    };
    
    // Force auth state update - can be called from browser console
    window.forceAuthUpdate = function() {
      console.log('=== FORCE AUTH UPDATE ===');
      onAuthStateChanged();
    };
    
    // Check OAuth callback specifically
    window.checkOAuthCallback = async function() {
      console.log('=== CHECKING OAUTH CALLBACK ===');
      const urlParams = new URLSearchParams(window.location.search);
      console.log('URL params:', Object.fromEntries(urlParams.entries()));
      
      if (supabase) {
        try {
          const { data, error } = await supabase.auth.getSession();
          console.log('Current session:', data?.session ? 'Present' : 'Missing');
          console.log('Session error:', error || 'None');
          
          if (data?.session) {
            console.log('User email:', data.session.user?.email);
            // Force UI update
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            
            if (authButtons) authButtons.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';
            if (userName) userName.textContent = data.session.user?.email;
            
            console.log('UI updated manually');
          }
        } catch (e) {
          console.log('OAuth callback check failed:', e);
        }
      }
    };
    // Toggle user dropdown
    function toggleUserDropdown() {
      const dropdown = document.getElementById('userDropdown');
      const arrow = document.getElementById('dropdownArrow');
      
      if (dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
        arrow.style.transform = 'rotate(0deg)';
      } else {
        dropdown.classList.add('show');
        arrow.style.transform = 'rotate(180deg)';
      }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('userDropdown');
      const userDropdown = document.querySelector('.user-dropdown');
      
      if (dropdown && !userDropdown.contains(event.target)) {
        dropdown.classList.remove('show');
        const arrow = document.getElementById('dropdownArrow');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    });
    
    // Logout function
    async function logout() {
      try {
        // Clear local authentication
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_email');
        
        // Clear Supabase authentication (Google OAuth)
        try {
          await supabase.auth.signOut();
          console.log('Supabase logout successful');
        } catch (e) {
          console.log('Supabase logout failed:', e);
        }
        
        onAuthStateChanged();
      } catch (err) {
        console.error('Logout error:', err);
      }
    }
    // Update subscription UI to use local auth
    async function checkUserAccess() {
      try {
        // Check for local authentication
        const token = localStorage.getItem('auth_token');
        const userEmail = localStorage.getItem('user_email');
        
        // Check for Supabase authentication
        let supabaseUser = null;
        try {
          const { data: { user } } = await supabase.auth.getUser();
          supabaseUser = user;
        } catch (e) {
          console.log('Supabase auth check failed:', e);
        }
        
        // Use Supabase user email if available, otherwise use local
        const email = supabaseUser ? supabaseUser.email : userEmail;
        
        if (!email) {
          return null;
        }
        
        const response = await fetch(`/api/subscription/access?user_email=${encodeURIComponent(email)}`);
        const access = await response.json();
        return { userEmail: email, access };
      } catch (error) {
        console.error('Error checking user access:', error);
        return null;
      }
    }
    async function updateSubscriptionUI() {
      const userAccess = await checkUserAccess();
      if (!userAccess) {
        document.getElementById('subscriptionStatus').style.display = 'none';
        document.getElementById('paymentRequired').style.display = 'none';
        return;
      }
      const { userEmail, access } = userAccess;
      if (access.is_active) {
        document.getElementById('subscriptionStatus').style.display = 'block';
        document.getElementById('paymentRequired').style.display = 'none';
        const details = document.getElementById('subscriptionDetails');
        if (access.access_type === 'trial') {
          details.innerHTML = `
            <strong>Free Trial Active</strong><br>
            ${access.forecasts_used} of ${access.forecasts_allowed} forecasts used<br>
            ${access.forecasts_remaining} forecasts remaining
          `;
        } else if (access.access_type === 'development') {
          details.innerHTML = `
            <strong>Development Mode Active</strong><br>
            Unlimited forecasts available<br>
            Payment system disabled for development
          `;
        } else {
          details.innerHTML = `
            <strong>${access.access_type === 'subscription' ? 'Monthly Subscription' : 'Lifetime Access'} Active</strong><br>
            ${access.forecasts_used} of ${access.forecasts_allowed} forecasts used<br>
            ${access.forecasts_remaining} forecasts remaining
          `;
        }
      } else {
        document.getElementById('subscriptionStatus').style.display = 'none';
        document.getElementById('paymentRequired').style.display = 'block';
      }
    }
    async function activateTrial() {
      try {
        const token = localStorage.getItem('auth_token');
        const userEmail = localStorage.getItem('user_email');
        if (!token || !userEmail) {
          showAuthModal();
          return;
        }
        const response = await fetch('/api/subscription/activate-trial', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_email: userEmail })
        });
        const result = await response.json();
        if (result.success) {
          showSuccess('Free trial activated successfully!');
          updateSubscriptionUI();
          hidePricingModal();
        } else {
          showError(result.error || 'Failed to activate trial');
        }
      } catch (error) {
        console.error('Error activating trial:', error);
        showError('Failed to activate trial');
      }
    }
    async function purchasePlan(productId) {
      try {
        const token = localStorage.getItem('auth_token');
        const userEmail = localStorage.getItem('user_email');
        
        // If not authenticated, show auth modal first
        if (!token || !userEmail) {
          hidePricingModal();
          showAuthModal();
          return;
        }
        
        const response = await fetch('/api/payments/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: productId, user_email: userEmail })
        });
        const result = await response.json();
        if (result.url) {
          hidePricingModal();
          window.location.href = result.url;
        } else {
          showError(result.error || 'Failed to create checkout session');
        }
      } catch (error) {
        console.error('Error creating checkout:', error);
        showError('Failed to create checkout session');
      }
    }
    // Restrict forecast functionality
    const origShowPage = showPage;
    showPage = function(id) {
      if (id === 'forecastPage') {
        // Allow guests to access forecast page
        origShowPage(id);
        // Check if user is authenticated and update UI accordingly
        const token = localStorage.getItem('auth_token');
        const userEmail = localStorage.getItem('user_email');
        if (token && userEmail) {
          setTimeout(updateSubscriptionUI, 100);
        }
      } else {
        origShowPage(id);
      }
    };

    // Pricing modal functions
      // function showPricingModal() {
      //   document.getElementById('pricingModal').style.display = 'flex';
      // }
      // function hidePricingModal() {
      //   document.getElementById('pricingModal').style.display = 'none';
      // }
    
    // Handle payment success/cancellation
    function handlePaymentReturn() {
      const urlParams = new URLSearchParams(window.location.search);
      const paymentStatus = urlParams.get('payment');
      const sessionId = urlParams.get('session_id');
      
      if (paymentStatus === 'success' && sessionId) {
        // Verify the payment
        verifyPayment(sessionId);
      } else if (paymentStatus === 'cancelled') {
        showError('Payment was cancelled');
      }
      
      // Clean up URL
      const newUrl = window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
    }
    
    async function verifyPayment(sessionId) {
      try {
        showModal('Verifying your payment...');
        
        const response = await fetch('/api/payments/verify-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSuccess('Payment verified! Your subscription is now active.');
          updateSubscriptionUI();
        } else {
          showError(result.error || 'Failed to verify payment');
        }
      } catch (error) {
        console.error('Error verifying payment:', error);
        showError('Failed to verify payment');
      } finally {
        hideModal();
      }
    }
    
    // On page load, check auth and handle payment returns
    window.addEventListener('DOMContentLoaded', async () => {
      // Handle payment return first
      handlePaymentReturn();
      
      // Set up Supabase auth state listener
      try {
        console.log('Setting up Supabase auth state listener...');
        const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
          console.log('=== SUPABASE AUTH STATE CHANGE ===');
          console.log('Event:', event);
          console.log('Session:', session ? 'Present' : 'Missing');
          console.log('User Email:', session?.user?.email || 'None');
          console.log('=====================================');
          onAuthStateChanged();
        });
        console.log('Supabase auth listener set up successfully');
      } catch (e) {
        console.log('Failed to set up Supabase auth listener:', e);
      }
      
      // Check local authentication
      onAuthStateChanged();
      
      // Also check auth state after a short delay to ensure everything is loaded
      setTimeout(() => {
        onAuthStateChanged();
      }, 500);
      
      // Additional check for OAuth redirect - check if we're coming back from OAuth
      setTimeout(() => {
        console.log('Checking for OAuth redirect...');
        onAuthStateChanged();
      }, 1000);
      
      // One more check after 2 seconds to catch any delayed auth state changes
      setTimeout(() => {
        console.log('Final auth state check...');
        onAuthStateChanged();
      }, 2000);
    });

      // --- Model selection All toggle logic ---
      document.addEventListener('DOMContentLoaded', function() {
        const allBox = document.getElementById('useAllModels');
        const arimaBox = document.getElementById('useARIMA');
        const hwBox = document.getElementById('useHW');
        const prophetBox = document.getElementById('useProphet');
        function updateAllBox() {
          allBox.checked = arimaBox.checked && hwBox.checked && prophetBox.checked;
        }
        allBox.addEventListener('change', function() {
          arimaBox.checked = hwBox.checked = prophetBox.checked = allBox.checked;
        });
        arimaBox.addEventListener('change', updateAllBox);
        hwBox.addEventListener('change', updateAllBox);
        prophetBox.addEventListener('change', updateAllBox);
        
        // Initialize forecast periods limit based on time unit
        updateForecastPeriodsLimit();
        
        // Add event listener for time unit changes
        const timeUnitSelect = document.getElementById('timeUnit');
        if (timeUnitSelect) {
          timeUnitSelect.addEventListener('change', updateForecastPeriodsLimit);
        }
    });
  </script>
  </main>
</body>
</html>
